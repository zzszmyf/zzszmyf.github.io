<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../../../img/favicon.ico">
  <title>Padding Oracle Attack - 西山下,闻溪语,书心境</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../../../css/theme.css" />
  <link rel="stylesheet" href="../../../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Padding Oracle Attack";
    var mkdocs_page_input_path = "crypto/blockcipher/mode/padding-oracle-attack.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../../../.." class="icon icon-home"> 西山下,闻溪语,书心境</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../../..">Index</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Crypto</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../../../introduction/">密码学简介</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">基础数学知识</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../basic/introduction/">简介</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">古典密码</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../classical/introduction/">古典密码简介</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../classical/monoalphabetic/">单表代换加密</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../classical/polyalphabetic/">多表代换加密</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../classical/others/">其他类型加密</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../classical/summary/">总结</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">流密码</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../streamcipher/intro/">介绍</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">伪随机数生成器</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../streamcipher/prng/intro/">介绍</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../streamcipher/prng/csprng/">密码学安全伪随机数生成器</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../streamcipher/prng/problem/">题目</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">线性同余生成器</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../streamcipher/lcg/intro/">简介</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../streamcipher/lcg/challenge/">例题</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">反馈移位寄存器</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../streamcipher/fsr/intro/">介绍</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../streamcipher/fsr/lfsr/">线性反馈移位寄存器</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../streamcipher/fsr/nfsr/">非线性反馈移位寄存器</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">特殊流密码</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../streamcipher/special/rc4/">RC4</a>
                </li>
    </ul>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="#">块加密</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../../introduction/">块加密简介</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../arx-operations/">ARX</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../des/">DES</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../idea/">IDEA</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../aes.md">AES</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../simon-speck/">Simon and Speck</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">分组模式</a>
    <ul class="current">
                <li class="toctree-l3"><a class="reference internal" href="../introduction/">介绍</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../padding/">填充方式</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../ecb/">ECB</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../cbc/">CBC</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../pcbc/">PCBC</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../cfb/">CFB</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../ofb/">OFB</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../ctr/">CTR</a>
                </li>
                <li class="toctree-l3 current"><a class="reference internal current" href="./">Padding Oracle Attack</a>
    <ul class="current">
    <li class="toctree-l4"><a class="reference internal" href="#introduction">Introduction</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#principle">Principle</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#2017-hitcon-secret-server">2017 HITCON Secret Server</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#2017-hitcon-secret-server-revenge">2017 HITCON Secret Server Revenge</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#teaser-dragon-ctf-2018-aes-128-tsb">Teaser Dragon CTF 2018 AES-128-TSB</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#references">References</a>
    </li>
    </ul>
                </li>
    </ul>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">非对称加密</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../asymmetric/introduction/">非对称加密简介</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">RSA</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../asymmetric/rsa/rsa_theory/">RSA 基本介绍</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../asymmetric/rsa/rsa_module_attack/">模数相关攻击</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../asymmetric/rsa/rsa_e_attack/">公钥指数相关攻击</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../asymmetric/rsa/rsa_d_attack/">私钥 d 相关攻击</a>
                </li>
                <li class="toctree-l3"><a class="" href="../../../asymmetric/rsa/rsa_coppersmith_attack.md">Coppersmith 相关攻击</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../asymmetric/rsa/rsa_chosen_plain_cipher/">选择明密文攻击</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../asymmetric/rsa/rsa_side_channel/">侧信道攻击</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../asymmetric/rsa/rsa_pkcs_attack/">Bleichenbacher 攻击</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../asymmetric/rsa/rsa_complex/">综合</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../asymmetric/knapsack/knapsack/">背包加密</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">离散对数相关</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../asymmetric/discrete-log/discrete-log/">离散对数</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../asymmetric/discrete-log/elgamal/">Elgamal</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../asymmetric/discrete-log/ecc/">ECC</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">格密码</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../asymmetric/lattice/overview/">格概述</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../asymmetric/lattice/introduction/">格介绍</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../asymmetric/lattice/lattice-reduction/">格基规约算法</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../asymmetric/lattice/cvp/">CVP</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">哈希函数</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../hash/introduction/">哈希函数简介</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../hash/md5/">MD5</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../hash/sha1/">SHA1</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../hash/fnv/">FNV</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../hash/attack/">Hash Attack</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../hash/complex/">综合</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">数字签名</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../signature/introduction/">数字签名简介</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../signature/rsa/">RSA 数字签名</a>
                </li>
                <li class="toctree-l3"><a class="" href="../../../signature/elgamal.md">ElGamal 数字签名</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../signature/dsa/">DSA 数字签名</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">攻击思想总结</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../attack-summary/attack-mode/">简介</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../attack-summary/meet-in-the-middle/">中间相遇攻击</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../attack-summary/bit-attack/">比特攻击</a>
                </li>
    </ul>
                </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../../../about/">About</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../..">西山下,闻溪语,书心境</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../..">Docs</a> &raquo;</li>
    
      
        
          <li>分组模式 &raquo;</li>
        
      
        
          <li>块加密 &raquo;</li>
        
      
        
          <li>Crypto &raquo;</li>
        
      
    
    <li>Padding Oracle Attack</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p><a href="./">EN</a> | <a href="../padding-oracle-attack-zh/">ZH</a></p>
<h1 id="padding-oracle-attack">Padding Oracle Attack<a class="headerlink" href="#padding-oracle-attack" title="Permanent link">&para;</a></h1>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>Padding Oracle Attack attacks generally need to meet the following conditions</p>
<ul>
<li>Encryption Algorithm</li>
<li>Encryption algorithm using PKCS5 Padding. Of course, the way OAEP is filled in asymmetric encryption may also be affected.</li>
<li>The grouping mode is CBC mode.</li>
<li>Attacker ability</li>
<li>An attacker can intercept messages encrypted by the above encryption algorithm.</li>
<li>The attacker can interact with the padding oracle (the server): the client sends the ciphertext to the server, and the server will use some kind of return information to inform the client whether the padding is normal.</li>
</ul>
<p>Padding Oracle Attack can achieve the following effects</p>
<ul>
<li>Decrypt any given ciphertext without knowing the key and IV.</li>
</ul>
<h2 id="principle">Principle<a class="headerlink" href="#principle" title="Permanent link">&para;</a></h2>
<p>The basic principles of the Padding Oracle Attack attack are as follows</p>
<ul>
<li>Decrypt a very long message piece by piece.</li>
<li>For each message, first decrypt the last byte of the message, then decrypt the second to last byte, and so on.</li>
</ul>
<p>Here we review the CBC</p>
<ul>
<li>Encryption</li>
</ul>
<p>$$</p>
<p>C_i=E_K(P_i \oplus C_{i-1})\</p>
<p>IV = C_0
$$</p>
<ul>
<li>Decryption</li>
</ul>
<p>$$</p>
<p>P_{i}=D_{K}(C_{i})\oplus C_{i-1}\ C_{0}=IV</p>
<p>$$</p>
<p>We mainly focus on decryption, we don&#39;t know IV and key here. Here we assume that the length of the ciphertext block is n bytes.</p>
<p>Suppose we intercepted ciphertext Y to obtain the last byte of ciphertext Y as an example for analysis. In order to obtain the content of Y, we first need to forge a piece of ciphertext F so that the last byte of the plaintext corresponding to Y can be modified. This is because if we construct the ciphertext <code>F|Y</code>, then the decryption Y is specifically
$$</p>
<p>P = D_K (Y)  oplus F
$$</p>
<p>So modify the last byte of ciphertext F, <span><span class="MathJax_Preview">F_{n}</span><script type="math/tex">F_{n}</script></span>, to modify the last byte of the plaintext corresponding to Y. The process of getting the last byte of P is given below.</p>
<ol>
<li>i=0, set each byte of F to be <strong>random byte</strong>.</li>
<li>Set <span><span class="MathJax_Preview">F_n=i \oplus 0x01</span><script type="math/tex">F_n=i \oplus 0x01</script></span></li>
<li>Send F|Y to the server. If the last byte of P is i, then the last padding is 0x01 and no error will occur. Otherwise, only the last <span><span class="MathJax_Preview">P_n \oplus i \oplus 0x01</span><script type="math/tex">P_n \oplus i \oplus 0x01</script></span> bytes of P are <span><span class="MathJax_Preview">P_n \oplus i \oplus 0x01</span><script type="math/tex">P_n \oplus i \oplus 0x01</script></span> and no error will be reported. <strong> Also, note that the padding bytes can only be 0 to n. </strong> Therefore, if you want to make the error in the case of F randomly and satisfy the padding byte size, the probability is small**. So in the case of no error on the server side, we can think that we did get the correct bytes.</li>
<li>In the event of an error, i=i+1, jump to 2.</li>
</ol>
<p>After getting the last byte of P, we can continue to get the second-to-last byte of P. In this case, we need to set <span><span class="MathJax_Preview">F_n=P_n\oplus 0x02</span><script type="math/tex">F_n=P_n\oplus 0x02</script></span> and set <span><span class="MathJax_Preview">F_{n-1}=i \oplus 0x02</span><script type="math/tex">F_{n-1}=i \oplus 0x02</script></span> to enumerate i.</p>
<p>So, in summary, Padding Oracle Attack is actually a method of attack with a high probability of success.</p>
<p>However, it&#39;s important to note that some of the real-world problems that are often encountered are not the standard Padding Oracle Attack mode, and we often need to make some changes.</p>
<h2 id="2017-hitcon-secret-server">2017 HITCON Secret Server<a class="headerlink" href="#2017-hitcon-secret-server" title="Permanent link">&para;</a></h2>
<h3 id="analysis">Analysis<a class="headerlink" href="#analysis" title="Permanent link">&para;</a></h3>
<p>The encryption used in the program is AES CBC, which uses padding similar to PKCS5.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>

    <span class="n">pad_length</span> <span class="o">=</span> <span class="mi">16</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">%</span><span class="mi">16</span>

    <span class="k">return</span> <span class="n">msg</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="n">pad_length</span><span class="p">)</span><span class="o">*</span><span class="n">pad_length</span>



<span class="k">def</span> <span class="nf">unpad</span> <span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">msg</span><span class="p">[:</span><span class="o">-</span><span class="nb">ord</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
</code></pre></div>

<p>However, in each unpad, no detection is performed, but the unpad is directly executed.</p>
<p>Among them, it should be noted that the function that interacts with the user each time is</p>
<ul>
<li><code>send_msg</code> , accepts the user&#39;s plaintext, encrypts it with a fixed <code>2jpmLoSsOlQrqyqE</code>, and outputs the encrypted result.</li>
<li><code>recv_msg</code> , accepts the user&#39;s IV and ciphertext, decrypts the ciphertext, and returns. There will be different actions depending on the results returned.</li>
</ul>
<div class="highlight"><pre><span></span><code>            <span class="n">msg</span> <span class="o">=</span> <span class="n">recv_msg</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;exit-here&#39;</span><span class="p">):</span>

                <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;get-flag&#39;</span><span class="p">):</span>

                <span class="n">send_msg</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;get-md5&#39;</span><span class="p">):</span>

                <span class="n">send_msg</span><span class="p">(</span><span class="n">MD5</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">7</span><span class="p">:])</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span>

            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;get-time&#39;</span><span class="p">):</span>

                <span class="n">send_msg</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>

            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;get-sha1&#39;</span><span class="p">):</span>

                <span class="n">send_msg</span><span class="p">(</span><span class="n">SHA</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">8</span><span class="p">:])</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span>

            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;get-sha256&#39;</span><span class="p">):</span>

                <span class="n">send_msg</span><span class="p">(</span><span class="n">SHA256</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">10</span><span class="p">:])</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span>

            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;get-hmac&#39;</span><span class="p">):</span>

                <span class="n">send_msg</span><span class="p">(</span><span class="n">HMAC</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">8</span><span class="p">:])</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">send_msg</span><span class="p">(</span><span class="s1">&#39;command not found&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="main-vulnerabilities">Main Vulnerabilities<a class="headerlink" href="#main-vulnerabilities" title="Permanent link">&para;</a></h3>
<p>Here we briefly summarize the parts we have.</p>
<ul>
<li>Encryption</li>
<li>The IV when encrypting is fixed and known.</li>
<li>&#39;Welcome!!&#39; Encrypted result.</li>
<li>Decryption</li>
<li>We can control IV.</li>
</ul>
<p>First of all, since we know the result of the <code>Welcome!!</code> encryption, we can also control the IV in recv_msg, then according to the decryption process
$$</p>
<p>P_{i}=D_{K}(C_{i})\oplus C_{i-1}\ C_{0}=IV</p>
<p>$$</p>
<p>If we enter the encrypted result of <code>Welcome!!</code> into recv_msg, the result of direct decryption is <code>(Welcome!!+&amp;#39;\x07&amp;#39;*7) xor iv</code>, if we <strong> properly control the decryption process In the iv</strong> passed, then we can control the decrypted result. In other words, we can execute any of the commands described above**. Thus, we can also know the result of the <code>flag</code> decryption.</p>
<p>Secondly, on the above basis, if we add the custom IV and Welcome encrypted result after any ciphertext C and pass it to recv_msg as input, then we can control the last byte of the message after decryption. <strong>So due to the unpad operation, we can control the length of the decrypted message to be reduced from 0 to 255</strong>.</p>
<h3 id="using-ideas">Using ideas<a class="headerlink" href="#using-ideas" title="Permanent link">&para;</a></h3>
<p>Basic use ideas are as follows</p>
<p>Bypass proof of work
2. Obtain the encrypted flag according to the way you execute any command.
3. Since the beginning of the flag is <code>hitcon{</code>, there are 7 bytes in total, so we can still control the iv to make the first 7 bytes after decryption the specified byte. This allows us to execute the <code>get-md5</code> command on the decrypted message. According to the unpad operation, we can control the decrypted message exactly at the first few bytes of the message. So we can start controlling the decrypted message as <code>hitcon{x</code>, that is, only one byte after <code>hitcon{</code>. This will result in an encrypted result with a one-byte hash. Similarly, we can also get the result of the encryption with a byte hash.
4. In this case, we can blast locally byte by byte, calculate the corresponding <code>md5</code>, and then use the arbitrary command execution mode to control the decrypted plaintext to any specified command. If the control is unsuccessful, it means that the byte is incorrect. , need to blast again; if it is correct, then you can directly execute the corresponding command.</p>
<p>The specific code is as follows</p>
<div class="highlight"><pre><span></span><code><span class="c1">#coding=utf-8</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">base64</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">string</span>

<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>

<span class="kn">from</span> <span class="nn">Crypto.Hash</span> <span class="kn">import</span> <span class="n">SHA256</span><span class="p">,</span> <span class="n">MD5</span>

<span class="c1">#context.log_level = &#39;debug&#39;</span>

<span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;REMOTE&#39;</span><span class="p">]:</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;52.193.157.19&#39;</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">7777</span><span class="p">)</span>





<span class="k">def</span> <span class="nf">strxor</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span> <span class="n">str2</span><span class="p">):</span>

    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c2</span><span class="p">))</span> <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span> <span class="n">str2</span><span class="p">)])</span>





<span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>

    <span class="n">pad_length</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span>

    <span class="k">return</span> <span class="n">msg</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">pad_length</span><span class="p">)</span> <span class="o">*</span> <span class="n">pad_length</span>





<span class="k">def</span> <span class="nf">unpad</span> <span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<span class="n">Return</span> <span class="n">msg</span><span class="p">[:</span><span class="o">-</span><span class="nb">ord</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span> <span class="c1"># Remove the pad</span>




<span class="k">def</span> <span class="nf">flipplain</span><span class="p">(</span><span class="n">oldplain</span><span class="p">,</span> <span class="n">newplain</span><span class="p">,</span> <span class="n">iv</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;flip oldplain to new plain, return proper iv&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">strxor</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="n">oldplain</span><span class="p">,</span> <span class="n">newplain</span><span class="p">),</span> <span class="n">iv</span><span class="p">)</span>





<span class="k">def</span> <span class="nf">bypassproof</span><span class="p">():</span>

    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;SHA256(XXXX+&#39;</span><span class="p">)</span>

    <span class="n">lastdata</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39; == &#39;</span><span class="p">)</span>

    <span class="n">digest</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Give me XXXX:&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">proof</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">SHA256</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">lastdata</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span> <span class="n">digest</span>



<span class="n">data</span> <span class="o">=</span> <span class="n">pwnlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">iters</span><span class="o">.</span><span class="n">mbruteforce</span> <span class="p">(</span>
        <span class="n">proof</span><span class="p">,</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Done!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>





<span class="n">iv_encrypt</span> <span class="o">=</span> <span class="s1">&#39;2jpmLoSsOlQrqyqE&#39;</span>





<span class="k">def</span> <span class="nf">getmd5enc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cipher_flag</span><span class="p">,</span> <span class="n">cipher_welcome</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;return encrypt( md5( flag[7:7+i] ) )&quot;&quot;&quot;</span>

    <span class="c1">## keep iv[7:] do not change, so decrypt won&#39;t change</span>

<span class="n">new_iv</span> <span class="o">=</span> <span class="n">flipplain</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">hitcon</span> <span class="p">{</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">.</span> <span class="n">bright</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">x00</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;),</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">get</span><span class="o">-</span><span class="n">md5</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">.</span><span class="n">light</span> <span class="p">(</span>
        <span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">iv_encrypt</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">new_iv</span> <span class="o">+</span> <span class="n">cipher_flag</span>

    <span class="c1">## calculate the proper last byte number</span>

    <span class="n">last_byte_iv</span> <span class="o">=</span> <span class="n">flipplain</span><span class="p">(</span>

        <span class="n">pad</span><span class="p">(</span><span class="s2">&quot;Welcome!!&quot;</span><span class="p">),</span>

        <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">15</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cipher_flag</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">-</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">iv_encrypt</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">+=</span> <span class="n">last_byte_iv</span> <span class="o">+</span> <span class="n">cipher_welcome</span>

    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>





<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="n">bypassproof</span><span class="p">()</span>



    <span class="c1"># result of encrypted Welcome!!</span>

    <span class="n">cipher</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">cipher_welcome</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">cipher</span><span class="p">)[</span><span class="mi">16</span><span class="p">:]</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;cipher welcome is : &quot;</span> <span class="o">+</span> <span class="n">cipher_welcome</span><span class="p">)</span>



    <span class="c1"># execute get-flag</span>

    <span class="n">get_flag_iv</span> <span class="o">=</span> <span class="n">flipplain</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="s2">&quot;Welcome!!&quot;</span><span class="p">),</span> <span class="n">pad</span><span class="p">(</span><span class="s2">&quot;get-flag&quot;</span><span class="p">),</span> <span class="n">iv_encrypt</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">get_flag_iv</span> <span class="o">+</span> <span class="n">cipher_welcome</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="n">cipher</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">cipher_flag</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">cipher</span><span class="p">)[</span><span class="mi">16</span><span class="p">:]</span>

    <span class="n">flaglen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cipher_flag</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;cipher flag is : &quot;</span> <span class="o">+</span> <span class="n">cipher_flag</span><span class="p">)</span>



    <span class="c1"># get command not found cipher</span>

    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">iv_encrypt</span> <span class="o">+</span> <span class="n">cipher_welcome</span><span class="p">))</span>

    <span class="n">cipher_notfound</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>



    <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># brute force for every byte of flag</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">flaglen</span> <span class="o">-</span> <span class="mi">7</span><span class="p">):</span>

        <span class="n">md5_indexi</span> <span class="o">=</span> <span class="n">getmd5enc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cipher_flag</span><span class="p">,</span> <span class="n">cipher_welcome</span><span class="p">)</span>

<span class="n">md5_indexi</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span> <span class="p">(</span><span class="n">md5_indexi</span><span class="p">)</span> <span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;get encrypt(md5(flag[7:7+i])): &quot;</span> <span class="o">+</span> <span class="n">md5_indexi</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">guess</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>

            <span class="c1"># locally compute md5 hash</span>

            <span class="n">guess_md5</span> <span class="o">=</span> <span class="n">MD5</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">flag</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">guess</span><span class="p">))</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

            <span class="c1"># try to null out the md5 plaintext and execute a command</span>

            <span class="n">payload</span> <span class="o">=</span> <span class="n">flipplain</span><span class="p">(</span><span class="n">guess_md5</span><span class="p">,</span> <span class="s1">&#39;get-time&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span><span class="p">),</span>

                                <span class="n">iv_encrypt</span><span class="p">)</span>

            <span class="n">payload</span> <span class="o">+=</span> <span class="n">md5_indexi</span>

            <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># if we receive the block for &#39;command not found&#39;, the hash was wrong</span>

            <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="n">cipher_notfound</span><span class="p">:</span>

                <span class="nb">print</span> <span class="s1">&#39;Guess </span><span class="si">{}</span><span class="s1"> is wrong.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>

            <span class="c1"># otherwise we correctly guessed the hash and the command was executed</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="nb">print</span> <span class="s1">&#39;Found!&#39;</span>

                <span class="n">flag</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>

                <span class="nb">print</span> <span class="s1">&#39;Flag so far:&#39;</span><span class="p">,</span> <span class="n">flag</span>

                <span class="k">break</span>





<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<p>The final result is as follows</p>
<div class="highlight"><pre><span></span><code>Flag so far: Paddin9_15_ve3y_h4rd__!!<span class="o">}</span><span class="se">\x</span><span class="m">10</span><span class="se">\x</span><span class="m">10</span><span class="se">\x</span><span class="m">10</span><span class="se">\x</span><span class="m">10</span><span class="se">\x</span><span class="m">10</span><span class="se">\x</span><span class="m">10</span><span class="se">\x</span><span class="m">10</span><span class="se">\x</span><span class="m">10</span><span class="se">\x</span><span class="m">10</span><span class="se">\x</span><span class="m">10</span><span class="se">\x</span><span class="m">10</span><span class="se">\x</span><span class="m">10</span><span class="se">\x</span><span class="m">10</span><span class="se">\x</span><span class="m">10</span><span class="se">\x</span><span class="m">10</span><span class="se">\x</span><span class="m">10</span>
</code></pre></div>

<h2 id="2017-hitcon-secret-server-revenge">2017 HITCON Secret Server Revenge<a class="headerlink" href="#2017-hitcon-secret-server-revenge" title="Permanent link">&para;</a></h2>
<h3 id="description">Description<a class="headerlink" href="#description" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>The password of zip is the flag of &quot;Secret Server&quot;
</code></pre></div>

<h3 id="analysis_1">Analysis<a class="headerlink" href="#analysis_1" title="Permanent link">&para;</a></h3>
<p>This program continues with the above program, but this time a simple modification</p>
<ul>
<li>The iv of the encryption algorithm is unknown, but can be derived from the message encrypted by Welcome.</li>
<li>The program has a 56-byte token.</li>
<li>The program can perform up to 340 operations, so the above blasting is naturally not feasible</li>
</ul>
<p>The general process of the program is as follows</p>
<p>After proof of work
2. Send &quot;Welcome!!&quot; encrypted message
3. In 340 operations, you need to guess the value of the token and then automatically output the flag.</p>
<h3 id="vulnerability">Vulnerability<a class="headerlink" href="#vulnerability" title="Permanent link">&para;</a></h3>
<p>Of course, the loopholes in the previous topic still exist in this topic, namely</p>
<ol>
<li>Execute the given command arbitrarily</li>
<li>Length truncation</li>
</ol>
<h3 id="using-ideas_1">Using ideas<a class="headerlink" href="#using-ideas_1" title="Permanent link">&para;</a></h3>
<p>Due to the limitation of the number of 340, although we can still get the value of <code>md5(token[:i])</code> encrypted (<strong> here we need to pay attention to this part of the encryption is exactly 32 bytes, the first 16 bytes are The value after md5 is encrypted, the next 16 bytes are completely filled with encrypted bytes.</strong> Here <code>md5(token[:i])</code> refers specifically to the first 16 bytes.). However, we can&#39;t blast 256 times again in order to get a character.</p>
<p>Since it is not possible to blast, is it possible to get the size of one byte at a time? Here, let&#39;s take a look at the information that the program may leak.</p>
<ol>
<li>The encrypted value of the md5 value of some messages. Here we can get the encrypted value of <code>md5(token[:i])</code>.</li>
<li>Unpad will unmap the decrypted message each time. This byte is determined based on the last byte of the decrypted message. If we can calculate the size of this byte, then we may know the value of a byte.</li>
</ol>
<p>Here we delve into the information leak of unpad. If we put the encryption IV and <code>encrypt(md5(token[:i]))</code> after a ciphertext C to form <code>C|IV|encrypt(md5(token[:i]))</code>, then decrypt The last plaintext block of the outgoing message is <code>md5(token[:i])</code>. Furthermore, in the unpad, the last byte (0-255) of <code>md5(token[:i])</code> is used for unpad, and then the specified command (such as md5) is executed on the string after the unpad. Then, if we <strong> pre-configure some hashed samples after the message hash, and then compare the results of the above execution with the sample, if they are the same, then we can basically determine the <code>md5(token[:i])</code> * * Last byte</strong>. However, if the last byte of <code>md5(token[:i])</code> is less than 16, then some values in md5 will be used in unpad, and this part of the value, due to <code>token[:i] for different lengths</code> Almost all will not be the same. So special handling may be required.</p>
<p>We already know the key to this problem, which is to generate a sample of the encrypted result corresponding to the size of the unpad byte, in order to facilitate the lookup table.</p>
<p>The specific use ideas are as follows</p>
<ol>
<li>Bypass proof of work.</li>
<li>Get the token encrypted result <code>token_enc</code> , which will add 7 bytes <code>&amp;quot;token: &amp;quot;</code> in front of the token. Therefore, the length after encryption is 64.</li>
<li>Get the result of <code>encrypt(md5(token[:i]))</code>, which is a total of 57, including the padding of the last token.</li>
<li>Construct a sample that corresponds to the size of the unpad. Here we construct the ciphertext <code>token_enc|padding|IV_indexi|welcome_enc</code>. Since <code>IV_indexi</code> is to modify the last byte of the last plaintext block, the byte is in the process of being changed. If we want to get some fixed byte hashes, this part can&#39;t be added naturally. Therefore, the size of the unpad ranges from 17 to 255 when the sample is generated here. If the last byte of <code>md5(token[:i])</code> is less than 17 at the end of the test, there will be some unknown samples. A natural idea is that we directly get 255-17+1 such multiple samples, however, if we do this, according to the number of times above 340 (255-17+1+57+56&gt;340), we obviously can&#39;t Get all the bytes to the token. So here we need to find ways to reuse some content, here we choose to reuse the result of <code>encrypt(md5(token[:i]))</code>. Then we need to ensure that the number of times is sufficient on the one hand, and on the other hand, the previous results can be reused. Here we set the unpad loop to 17 to 208, and make the unpad more than 208 when we just unpad to where we can reuse. It should be noted here that when the last byte of <code>md5(token[:i])</code> is 0, all decrypted plaintext unpad will be dropped, so the ciphertext of command not found will appear.</li>
<li>Construct the ciphertext <code>token_enc|padding|IV|encrypt(md5(token[:i]))</code> again, then use the last byte of <code>md5(token[:i])</code> for unpad when decrypting. If this byte is not less than 17 or 0, it can be processed. If this byte is less than 17, then obviously, the result of the last md5 returned to the user is not within the sample range, then we modify the highest bit of its last byte so that it can fall within the sample range after the unpad. In this way, we can guess the last byte of <code>md5(token[:i])</code>.</li>
<li>After guessing the last byte of <code>md5(token[:i])</code>, we can brute 256 times locally and find out that all hashes are at the end of <code>md5(token[:i])</code> The last byte of the character.</li>
<li>However, in the sixth step, for a <code>md5(token[:i])</code> we may find multiple alternative characters because we only need to make the last byte of the given byte.</li>
<li>So, the question is, how do you delete some extra candidate strings? Here I chose a small trick, which enumerates the padding of the token at the same time as the byte-by-byte enumeration. Since padding is fixed at 0x01, we only need to filter out all tokens that are not 0x01 at the end.</li>
</ol>
<p>Here, the <code>sleep</code> in the code is commented out during the test. In order to speed up the interaction. Use the code as follows</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">base64</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">string</span>

<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>

<span class="kn">from</span> <span class="nn">Crypto.Hash</span> <span class="kn">import</span> <span class="n">SHA256</span><span class="p">,</span> <span class="n">MD5</span>

<span class="c1">#context.log_level = &#39;debug&#39;</span>



<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">7777</span><span class="p">)</span>





<span class="k">def</span> <span class="nf">strxor</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span> <span class="n">str2</span><span class="p">):</span>

    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c2</span><span class="p">))</span> <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span> <span class="n">str2</span><span class="p">)])</span>





<span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>

    <span class="n">pad_length</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span>

    <span class="k">return</span> <span class="n">msg</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">pad_length</span><span class="p">)</span> <span class="o">*</span> <span class="n">pad_length</span>





<span class="k">def</span> <span class="nf">unpad</span> <span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">msg</span><span class="p">[:</span><span class="o">-</span><span class="nb">ord</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>  <span class="c1"># remove pad</span>





<span class="k">def</span> <span class="nf">flipplain</span><span class="p">(</span><span class="n">oldplain</span><span class="p">,</span> <span class="n">newplain</span><span class="p">,</span> <span class="n">iv</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;flip oldplain to new plain, return proper iv&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">strxor</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="n">oldplain</span><span class="p">,</span> <span class="n">newplain</span><span class="p">),</span> <span class="n">iv</span><span class="p">)</span>





<span class="k">def</span> <span class="nf">bypassproof</span><span class="p">():</span>

    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;SHA256(XXXX+&#39;</span><span class="p">)</span>

    <span class="n">lastdata</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39; == &#39;</span><span class="p">)</span>

    <span class="n">digest</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Give me XXXX:&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">proof</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">SHA256</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">lastdata</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span> <span class="n">digest</span>



<span class="n">data</span> <span class="o">=</span> <span class="n">pwnlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">iters</span><span class="o">.</span><span class="n">mbruteforce</span> <span class="p">(</span>
        <span class="n">proof</span><span class="p">,</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>





<span class="k">def</span> <span class="nf">sendmsg</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="n">cipher</span><span class="p">):</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">iv</span> <span class="o">+</span> <span class="n">cipher</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>





<span class="k">def</span> <span class="nf">recvmsg</span><span class="p">():</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span><span class="p">[:</span><span class="mi">16</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>





<span class="k">def</span> <span class="nf">getmd5enc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cipher_token</span><span class="p">,</span> <span class="n">cipher_welcome</span><span class="p">,</span> <span class="n">iv</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;return encrypt( md5( token[:i+1] ) )&quot;&quot;&quot;</span>

    <span class="c1">## keep iv[7:] do not change, so decrypt msg[7:] won&#39;t change</span>

<span class="n">get_md5_iv</span> <span class="o">=</span> <span class="n">flipplain</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">token</span><span class="p">:</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">.</span><span class="n">lit</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">x00</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;),</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">get</span><span class="o">-</span><span class="n">md5</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">.</span>
        <span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">iv</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">cipher_token</span>

    <span class="c1">## calculate the proper last byte number</span>

    <span class="n">last_byte_iv</span> <span class="o">=</span> <span class="n">flipplain</span><span class="p">(</span>

        <span class="n">pad</span><span class="p">(</span><span class="s2">&quot;Welcome!!&quot;</span><span class="p">),</span>

        <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">15</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cipher_token</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">-</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">iv</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">+=</span> <span class="n">last_byte_iv</span> <span class="o">+</span> <span class="n">cipher_welcome</span>

    <span class="n">sendmsg</span><span class="p">(</span><span class="n">get_md5_iv</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">recvmsg</span><span class="p">()</span>





<span class="k">def</span> <span class="nf">get_md5_token_indexi</span><span class="p">(</span><span class="n">iv_encrypt</span><span class="p">,</span> <span class="n">cipher_welcome</span><span class="p">,</span> <span class="n">cipher_token</span><span class="p">):</span>

    <span class="n">md5_token_idxi</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cipher_token</span><span class="p">)</span> <span class="o">-</span> <span class="mi">7</span><span class="p">):</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;idx i: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">md5_indexi</span> <span class="o">=</span> <span class="n">getmd5enc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cipher_token</span><span class="p">,</span> <span class="n">cipher_welcome</span><span class="p">,</span> <span class="n">iv_encrypt</span><span class="p">)</span>

<span class="k">assert</span> <span class="p">(</span><span class="n">only</span> <span class="p">(</span><span class="n">md5_indexi</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>        <span class="c1"># remove the last 16 byte for padding</span>

        <span class="n">md5_token_idxi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">md5_indexi</span><span class="p">[:</span><span class="mi">16</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">md5_token_idxi</span>





<span class="k">def</span> <span class="nf">doin</span><span class="p">(</span><span class="n">unpadcipher</span><span class="p">,</span> <span class="n">md5map</span><span class="p">,</span> <span class="n">candidates</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">unpadcipher</span> <span class="ow">in</span> <span class="n">md5map</span><span class="p">:</span>

        <span class="n">lastbyte</span> <span class="o">=</span> <span class="n">md5map</span><span class="p">[</span><span class="n">unpadcipher</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">lastbyte</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">lastbyte</span> <span class="o">^=</span> <span class="mh">0x80</span>

    <span class="n">newcandidates</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">MD5</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">c</span><span class="p">))</span><span class="o">.</span><span class="n">digest</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">chr</span><span class="p">(</span><span class="n">lastbyte</span><span class="p">):</span>

                <span class="n">newcandidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>

    <span class="n">candidates</span> <span class="o">=</span> <span class="n">newcandidates</span>

    <span class="nb">print</span> <span class="n">candidates</span>

    <span class="k">return</span> <span class="n">candidates</span>





<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="n">bypassproof</span><span class="p">()</span>



    <span class="c1"># result of encrypted Welcome!!</span>

    <span class="n">iv_encrypt</span><span class="p">,</span> <span class="n">cipher_welcome</span> <span class="o">=</span> <span class="n">recvmsg</span><span class="p">()</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;cipher welcome is : &quot;</span> <span class="o">+</span> <span class="n">cipher_welcome</span><span class="p">)</span>



    <span class="c1"># execute get-token</span>

    <span class="n">get_token_iv</span> <span class="o">=</span> <span class="n">flipplain</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="s2">&quot;Welcome!!&quot;</span><span class="p">),</span> <span class="n">pad</span><span class="p">(</span><span class="s2">&quot;get-token&quot;</span><span class="p">),</span> <span class="n">iv_encrypt</span><span class="p">)</span>

    <span class="n">sendmsg</span><span class="p">(</span><span class="n">get_token_iv</span><span class="p">,</span> <span class="n">cipher_welcome</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">cipher_token</span> <span class="o">=</span> <span class="n">recvmsg</span><span class="p">()</span>

<span class="n">token_len</span> <span class="o">=</span> <span class="n">only</span> <span class="p">(</span><span class="n">cipher_token</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;cipher token is : &quot;</span> <span class="o">+</span> <span class="n">cipher_token</span><span class="p">)</span>



    <span class="c1"># get command not found cipher</span>

    <span class="n">sendmsg</span><span class="p">(</span><span class="n">iv_encrypt</span><span class="p">,</span> <span class="n">cipher_welcome</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">cipher_notfound</span> <span class="o">=</span> <span class="n">recvmsg</span><span class="p">()</span>



    <span class="c1"># get encrypted(token[:i+1]),57 times</span>

    <span class="n">md5_token_idx_list</span> <span class="o">=</span> <span class="n">get_md5_token_indexi</span><span class="p">(</span><span class="n">iv_encrypt</span><span class="p">,</span> <span class="n">cipher_welcome</span><span class="p">,</span>

                                              <span class="n">cipher_token</span><span class="p">)</span>

    <span class="c1"># get md5map for each unpadsize, 209-17 times</span>

    <span class="c1"># when upadsize&gt;208, it will unpad ciphertoken</span>

    <span class="c1"># then we can reuse</span>

<span class="n">md5map</span> <span class="o">=</span> <span class="nb">dict</span> <span class="p">()</span>
    <span class="k">for</span> <span class="n">unpadsize</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">209</span><span class="p">):</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;get unpad size </span><span class="si">{}</span><span class="s2"> cipher&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unpadsize</span><span class="p">))</span>

<span class="n">get_md5_iv</span> <span class="o">=</span> <span class="n">flipplain</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">token</span><span class="p">:</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">.</span><span class="n">lit</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">x00</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;),</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">get</span><span class="o">-</span><span class="n">md5</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">.</span>
            <span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">iv_encrypt</span><span class="p">)</span>

        <span class="c1">## padding 16*11 bytes</span>

        <span class="n">padding</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">11</span> <span class="o">*</span> <span class="s2">&quot;a&quot;</span>

        <span class="c1">## calculate the proper last byte number, only change the last byte</span>

        <span class="c1">## set last_byte_iv = iv_encrypted[:15] | proper byte</span>

        <span class="n">last_byte_iv</span> <span class="o">=</span> <span class="n">flipplain</span><span class="p">(</span>

            <span class="n">pad</span><span class="p">(</span><span class="s2">&quot;Welcome!!&quot;</span><span class="p">),</span>

            <span class="n">pad</span><span class="p">(</span><span class="s2">&quot;Welcome!!&quot;</span><span class="p">)[:</span><span class="mi">15</span><span class="p">]</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">unpadsize</span><span class="p">),</span> <span class="n">iv_encrypt</span><span class="p">)</span>

        <span class="n">cipher</span> <span class="o">=</span> <span class="n">cipher_token</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">last_byte_iv</span> <span class="o">+</span> <span class="n">cipher_welcome</span>

        <span class="n">sendmsg</span><span class="p">(</span><span class="n">get_md5_iv</span><span class="p">,</span> <span class="n">cipher</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">unpadcipher</span> <span class="o">=</span> <span class="n">recvmsg</span><span class="p">()</span>

        <span class="n">md5map</span><span class="p">[</span><span class="n">unpadcipher</span><span class="p">]</span> <span class="o">=</span> <span class="n">unpadsize</span>



    <span class="c1"># reuse encrypted(token[:i+1])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">209</span><span class="p">,</span> <span class="mi">256</span><span class="p">):</span>

        <span class="n">target</span> <span class="o">=</span> <span class="n">md5_token_idx_list</span><span class="p">[</span><span class="mi">56</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">209</span><span class="p">)]</span>

        <span class="n">md5map</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>



    <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>

    <span class="c1"># get the byte token[i], only 56 byte</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">token_len</span> <span class="o">-</span> <span class="mi">7</span><span class="p">):</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;get token[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

<span class="n">get_md5_iv</span> <span class="o">=</span> <span class="n">flipplain</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">token</span><span class="p">:</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">.</span><span class="n">lit</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">x00</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;),</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">get</span><span class="o">-</span><span class="n">md5</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">.</span>
            <span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">iv_encrypt</span><span class="p">)</span>

        <span class="c1">## padding 16*11 bytes</span>

        <span class="n">padding</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">11</span> <span class="o">*</span> <span class="s2">&quot;a&quot;</span>

        <span class="n">cipher</span> <span class="o">=</span> <span class="n">cipher_token</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">iv_encrypt</span> <span class="o">+</span> <span class="n">md5_token_idx_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">sendmsg</span><span class="p">(</span><span class="n">get_md5_iv</span><span class="p">,</span> <span class="n">cipher</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">unpadcipher</span> <span class="o">=</span> <span class="n">recvmsg</span><span class="p">()</span>

        <span class="c1"># already in or md5[token[:i]][-1]=&#39;\x00&#39;</span>

        <span class="k">if</span> <span class="n">unpadcipher</span> <span class="ow">in</span> <span class="n">md5map</span> <span class="ow">or</span> <span class="n">unpadcipher</span> <span class="o">==</span> <span class="n">cipher_notfound</span><span class="p">:</span>

            <span class="n">candidates</span> <span class="o">=</span> <span class="n">doin</span><span class="p">(</span><span class="n">unpadcipher</span><span class="p">,</span> <span class="n">md5map</span><span class="p">,</span> <span class="n">candidates</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">unpad</span> <span class="n">size</span> <span class="mi">1</span><span class="o">-</span><span class="mi">16</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;)</span>
            <span class="c1"># flip most significant bit of last byte to move it in a good range</span>

            <span class="n">cipher</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">[:</span><span class="o">-</span><span class="mi">17</span><span class="p">]</span> <span class="o">+</span> <span class="n">strxor</span><span class="p">(</span><span class="n">cipher</span><span class="p">[</span><span class="o">-</span><span class="mi">17</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\x80</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">cipher</span><span class="p">[</span><span class="o">-</span><span class="mi">16</span><span class="p">:]</span>

            <span class="n">sendmsg</span><span class="p">(</span><span class="n">get_md5_iv</span><span class="p">,</span> <span class="n">cipher</span><span class="p">)</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">unpadcipher</span> <span class="o">=</span> <span class="n">recvmsg</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">unpadcipher</span> <span class="ow">in</span> <span class="n">md5map</span> <span class="ow">or</span> <span class="n">unpadcipher</span> <span class="o">==</span> <span class="n">cipher_notfound</span><span class="p">:</span>

                <span class="n">candidates</span> <span class="o">=</span> <span class="n">doin</span><span class="p">(</span><span class="n">unpadcipher</span><span class="p">,</span> <span class="n">md5map</span><span class="p">,</span> <span class="n">candidates</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;oh my god,,,, it must be in...&#39;</span><span class="p">)</span>

                <span class="n">exit</span><span class="p">()</span>

    <span class="nb">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>

    <span class="c1"># padding 0x01</span>

    <span class="n">candidates</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0x01</span><span class="p">),</span> <span class="n">candidates</span><span class="p">)</span>

    <span class="c1"># only 56 bytes</span>

    <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">]</span>

    <span class="nb">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>

    <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">56</span><span class="p">)</span>



    <span class="c1"># check-token</span>

    <span class="n">check_token_iv</span> <span class="o">=</span> <span class="n">flipplain</span><span class="p">(</span>

        <span class="n">pad</span><span class="p">(</span><span class="s2">&quot;Welcome!!&quot;</span><span class="p">),</span> <span class="n">pad</span><span class="p">(</span><span class="s2">&quot;check-token&quot;</span><span class="p">),</span> <span class="n">iv_encrypt</span><span class="p">)</span>

    <span class="n">sendmsg</span><span class="p">(</span><span class="n">check_token_iv</span><span class="p">,</span> <span class="n">cipher_welcome</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Give me the token!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="nb">print</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>



    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>





<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<p>The effect is as follows</p>
<div class="highlight"><pre><span></span><code>...

<span class="m">79</span>

<span class="m">1</span>

hitcon <span class="o">{</span>uNp @ d_M3th0D_i5_am4Z1n9!<span class="o">}</span>
</code></pre></div>

<h2 id="teaser-dragon-ctf-2018-aes-128-tsb">Teaser Dragon CTF 2018 AES-128-TSB<a class="headerlink" href="#teaser-dragon-ctf-2018-aes-128-tsb" title="Permanent link">&para;</a></h2>
<p>This topic is still very interesting, the title is described as follows</p>
<div class="highlight"><pre><span></span><code>Haven&#39;t you ever thought that GCM mode is overcomplicated and there must be a simpler way to achieve Authenticated Encryption? Here it is!



Server: aes-128-tsb.hackable.software 1337



server.py
</code></pre></div>

<p>The attachment and the final exp are found by the ctf-challenge repository.</p>
<p>The basic process of the topic is</p>
<ul>
<li>Continuously receive two strings a and b, where a is plaintext and b is ciphertext, note</li>
<li>b needs to satisfy the tail just equal to iv after decryption.</li>
<li>if a and b are equal, then</li>
<li>a is <code>gimme_flag</code> and the encrypted flag is output.</li>
<li>Otherwise, output a string of randomly encrypted strings.</li>
<li>Otherwise output a string of plain text.</li>
</ul>
<p>In addition, we can also find that there is a problem with the unpad in the title, and the specified length can be truncated.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">unpad</span> <span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">:</span>

        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">return</span> <span class="n">msg</span><span class="p">[:</span><span class="o">-</span><span class="nb">ord</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
</code></pre></div>

<p>In the beginning, the very straightforward idea is to enter 0 for the lengths of a and b, then you can bypass the <code>a==b</code> check to get a string of random ciphertext encrypted strings. However, it does not seem to have any effect, let&#39;s analyze the encryption process.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">tsb_encrypt</span><span class="p">(</span><span class="n">aes</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="n">pad</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">iv</span> <span class="o">=</span> <span class="n">get_random_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

<span class="n">prev_pt</span> <span class="o">=</span> <span class="n">iv</span>
    <span class="n">prev_ct</span> <span class="o">=</span> <span class="n">iv</span>

    <span class="n">ct</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">split_by</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">iv</span><span class="p">]:</span>

        <span class="n">ct_block</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">prev_pt</span><span class="p">)</span>

        <span class="n">ct_block</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">ct_block</span><span class="p">)</span>

        <span class="n">ct_block</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">ct_block</span><span class="p">,</span> <span class="n">prev_ct</span><span class="p">)</span>

        <span class="n">ct</span> <span class="o">+=</span> <span class="n">ct_block</span>

        <span class="n">prev_pt</span> <span class="o">=</span> <span class="n">block</span>

        <span class="n">prev_ct</span> <span class="o">=</span> <span class="n">ct_block</span>

    <span class="k">return</span> <span class="n">iv</span> <span class="o">+</span> <span class="n">ct</span>
</code></pre></div>

<p>Let&#39;s assume that <span><span class="MathJax_Preview">P_0=iv, C_0=iv</span><script type="math/tex">P_0=iv, C_0=iv</script></span>, then</p>
<p><span><span class="MathJax_Preview">C_i=C_{i-1}\oplus E(P_{i-1} \oplus P_i)</span><script type="math/tex">C_i=C_{i-1}\oplus E(P_{i-1} \oplus P_i)</script></span></p>
<p>So, assuming the message length is 16, similar to the length of the <code>gimme_flag</code> padding we want to get, then</p>
<p>$ C_1 = IV  oplus E (IV  oplus P_1) $</p>
<p><span><span class="MathJax_Preview">C_2=C_1 \oplus E(P_1 \oplus IV)</span><script type="math/tex">C_2=C_1 \oplus E(P_1 \oplus IV)</script></span></p>
<p>It is easy to find <span><span class="MathJax_Preview">C_2=IV</span><script type="math/tex">C_2=IV</script></span>.</p>
<p>([Pirates] (<a href="https://github.com/pberba/ctf-solutions/tree/master/20180929_teaser_dragon/aes_128_tsb">https://github.com/pberba/ctf-solutions/tree/master/20180929_teaser_dragon/aes_128_tsb</a>), the picture below is clearer</p>
<p><img alt="" src="../figure/aes-tsb-encryption.png" /></p>
<p>Conversely, if we send <code>iv+c+iv</code> to the server, we can always bypass the <code>tsb_decrypt</code> mac check.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">tsb_decrypt</span><span class="p">(</span><span class="n">aes</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>

    <span class="n">iv</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[:</span><span class="mi">16</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>

<span class="n">prev_pt</span> <span class="o">=</span> <span class="n">iv</span>
    <span class="n">prev_ct</span> <span class="o">=</span> <span class="n">iv</span>

<span class="n">pt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="c1">#39;&amp;#39;</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">split_by</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>

        <span class="n">pt_block</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">prev_ct</span><span class="p">)</span>

        <span class="n">pt_block</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">pt_block</span><span class="p">)</span>

        <span class="n">pt_block</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">pt_block</span><span class="p">,</span> <span class="n">prev_pt</span><span class="p">)</span>

        <span class="n">pt</span> <span class="o">+=</span> <span class="n">pt_block</span>

        <span class="n">prev_pt</span> <span class="o">=</span> <span class="n">pt_block</span>

        <span class="n">prev_ct</span> <span class="o">=</span> <span class="n">block</span>

<span class="n">pt</span><span class="p">,</span> <span class="n">mac</span> <span class="o">=</span> <span class="n">pt</span> <span class="p">[:</span> <span class="o">-</span> <span class="mi">16</span><span class="p">],</span> <span class="n">pt</span> <span class="p">[</span><span class="o">-</span><span class="mi">16</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">mac</span> <span class="o">!=</span> <span class="n">iv</span><span class="p">:</span>

        <span class="k">raise</span> <span class="n">CryptoError</span><span class="p">()</span>

<span class="k">return</span> <span class="n">unpad</span> <span class="p">(</span><span class="n">pt</span><span class="p">)</span>
</code></pre></div>

<p>Then at this point, the message decrypted by the server is</p>
<p>$ unpad (IV  oplus D (C_1  oplus IV)) $</p>
<h3 id="get-the-last-byte-of-the-plaintext">Get the last byte of the plaintext<a class="headerlink" href="#get-the-last-byte-of-the-plaintext" title="Permanent link">&para;</a></h3>
<p>We can consider controlling the D decrypted message as a constant value, such as all zeros, ie <code>C1=IV</code>, then we can enumerate the last byte of the IV from 0 to 255, get $IV \oplus D(C_1 \oplus IV) The last byte of $ is also 0~255. Only when it is 1~15, after the <code>unpad</code> operation, the message length is not 0. Therefore, we can count which numbers cause the length to be non-zero and enumerate as 1 and the remaining flags to 0.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">getlast_byte</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>

<span class="n">iv_pre</span> <span class="o">=</span> <span class="n">iv</span> <span class="p">[:</span> <span class="mi">15</span><span class="p">]</span>
<span class="n">iv_last</span> <span class="o">=</span> <span class="n">words</span> <span class="p">(</span><span class="n">iv</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;get last byte&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>

        <span class="n">send_data</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="n">iv</span> <span class="o">=</span> <span class="n">iv_pre</span> <span class="o">+</span> <span class="nb">chr</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">tmpblock</span> <span class="o">=</span> <span class="n">block</span><span class="p">[:</span><span class="mi">15</span><span class="p">]</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">^</span> <span class="n">iv_last</span><span class="p">)</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="n">iv</span> <span class="o">+</span> <span class="n">tmpblock</span> <span class="o">+</span> <span class="n">iv</span>

        <span class="n">send_data</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

        <span class="n">length</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">recv_data</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;Looks&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>

            <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">last_bytes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">tmp</span> <span class="o">==</span> <span class="n">xor_byte_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>

            <span class="n">last_bytes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xor_byte_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;possible last byte is &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_bytes</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">last_bytes</span>
</code></pre></div>

<p>In addition, we can get all the possible cases of the last byte at the beginning of the table, recorded in xor_byte_map.</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">every item is a pair [a,b]</span>

<span class="sd">a is the xor list</span>

<span class="sd">b is the idx which is zero when xored</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="n">xor_byte_map</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>

    <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">i</span> <span class="o">^</span> <span class="n">j</span>

        <span class="k">if</span> <span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">:</span>

            <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">b</span> <span class="o">=</span> <span class="n">j</span>

    <span class="n">xor_byte_map</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
</code></pre></div>

<p>By comparing this table, we can know what is possible with the last byte.</p>
<h3 id="decrypt-any-encrypted-block">Decrypt any encrypted block<a class="headerlink" href="#decrypt-any-encrypted-block" title="Permanent link">&para;</a></h3>
<p>After obtaining the last byte of the plaintext, we can use the unpad vulnerability to get the corresponding plaintext content from length 1 to length 15.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">dec_block</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>

    <span class="n">last_bytes</span> <span class="o">=</span> <span class="n">getlast_byte</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>



<span class="n">iv_pre</span> <span class="o">=</span> <span class="n">iv</span> <span class="p">[:</span> <span class="mi">15</span><span class="p">]</span>
<span class="n">iv_last</span> <span class="o">=</span> <span class="n">words</span> <span class="p">(</span><span class="n">iv</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;try to get plain&#39;</span><span class="p">)</span>

<span class="n">plain0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="c1">#39;&amp;#39;</span>
    <span class="k">for</span> <span class="n">last_byte</span> <span class="ow">in</span> <span class="n">last_bytes</span><span class="p">:</span>

<span class="n">plain0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="c1">#39;&amp;#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>

            <span class="nb">print</span> <span class="s1">&#39;idx:&#39;</span><span class="p">,</span> <span class="n">i</span>

<span class="n">tag</span> <span class="o">=</span> <span class="n">false</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>

                <span class="n">send_data</span><span class="p">(</span><span class="n">plain0</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>

                <span class="n">pad_size</span> <span class="o">=</span> <span class="mi">15</span> <span class="o">-</span> <span class="n">i</span>

                <span class="n">iv</span> <span class="o">=</span> <span class="n">iv_pre</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">pad_size</span> <span class="o">^</span> <span class="n">last_byte</span><span class="p">)</span>

                <span class="n">tmpblock</span> <span class="o">=</span> <span class="n">block</span><span class="p">[:</span><span class="mi">15</span><span class="p">]</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span>

                    <span class="n">pad_size</span> <span class="o">^</span> <span class="n">last_byte</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">^</span> <span class="n">iv_last</span>

                <span class="p">)</span>

                <span class="n">payload</span> <span class="o">=</span> <span class="n">iv</span> <span class="o">+</span> <span class="n">tmpblock</span> <span class="o">+</span> <span class="n">iv</span>

                <span class="n">send_data</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

                <span class="n">length</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">recv_data</span><span class="p">()</span>

                <span class="k">if</span> <span class="s1">&#39;Looks&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>

                    <span class="c1"># success</span>

<span class="n">plain0</span> <span class="o">+</span> <span class="o">=</span> <span class="nb">chr</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>

                <span class="k">break</span>

        <span class="c1"># means the last byte is ok</span>

        <span class="k">if</span> <span class="n">plain0</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>

            <span class="k">break</span>

    <span class="n">plain0</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">iv_last</span> <span class="o">^</span> <span class="n">last_byte</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">plain0</span>
</code></pre></div>

<h3 id="decrypt-the-specified-plaintext">Decrypt the specified plaintext<a class="headerlink" href="#decrypt-the-specified-plaintext" title="Permanent link">&para;</a></h3>
<p>This is relatively simple, we hope to use this to get the ciphertext of <code>gimme_flag</code></p>
<div class="highlight"><pre><span></span><code>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;get the cipher of flag&#39;</span><span class="p">)</span>

    <span class="n">gemmi_iv1</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="s1">&#39;gimme_flag&#39;</span><span class="p">),</span> <span class="n">plain0</span><span class="p">)</span>

    <span class="n">gemmi_c1</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">gemmi_iv1</span><span class="p">,</span> <span class="n">cipher0</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">gemmi_iv1</span> <span class="o">+</span> <span class="n">gemmi_c1</span> <span class="o">+</span> <span class="n">gemmi_iv1</span>

    <span class="n">send_data</span><span class="p">(</span><span class="s1">&#39;gimme_flag&#39;</span><span class="p">)</span>

    <span class="n">send_data</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="n">flag_len</span><span class="p">,</span> <span class="n">flag_cipher</span> <span class="o">=</span> <span class="n">recv_data</span><span class="p">()</span>
</code></pre></div>

<p>Where plain0 and cipher0 are the clear ciphertext pairs we obtained for AES encryption, excluding the two exclusive ORs before and after.</p>
<h3 id="decrypt-flag">Decrypt flag<a class="headerlink" href="#decrypt-flag" title="Permanent link">&para;</a></h3>
<p>This point is actually achieved by the function of decrypting any encrypted block, as follows</p>
<div class="highlight"><pre><span></span><code>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;the flag cipher is &#39;</span> <span class="o">+</span> <span class="n">flag_cipher</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">))</span>

    <span class="n">flag_cipher</span> <span class="o">=</span> <span class="n">split_by</span><span class="p">(</span><span class="n">flag_cipher</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>



    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;decrypt the blocks one by one&#39;</span><span class="p">)</span>

    <span class="n">plain</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flag_cipher</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;block: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">plain</span> <span class="o">+=</span> <span class="n">dec_block</span><span class="p">(</span><span class="n">flag_cipher</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">flag_cipher</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>

<span class="n">iv</span> <span class="o">=</span> <span class="n">plain</span> <span class="p">[</span><span class="o">-</span><span class="mi">16</span><span class="p">:]</span>
            <span class="n">cipher</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">xor</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="n">flag_cipher</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">flag_cipher</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="n">plain</span> <span class="o">+=</span> <span class="n">dec_block</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="n">cipher</span><span class="p">)</span>

            <span class="k">pass</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;now plain: &#39;</span> <span class="o">+</span> <span class="n">plain</span><span class="p">)</span>

    <span class="nb">print</span> <span class="n">plain</span>
</code></pre></div>

<p>Think about why the ciphertext operation after the second block will be different.</p>
<p>The complete code references the ctf-challenge repository.</p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li>[Packet Encryption Mode] (<a href="https://en.wikipedia.org/wiki/%E5%88%86%E7%BB%84%E5%AF%86%E7%A0%81%E5%B7%A5">https://en.wikipedia.org/wiki/%E5%88%86%E7%BB%84%E5%AF%86%E7%A0%81%E5%B7%A5</a>% E4%BD%9C%E6%A8%A1%E5%BC%8F)</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Padding_oracle_attack">https://en.wikipedia.org/wiki/Padding_oracle_attack</a></p>
</li>
<li>
<p><a href="http://netifera.com/research/poet/PaddingOraclesEverywhereEkoparty2010.pdf">http://netifera.com/research/poet/PaddingOraclesEverywhereEkoparty2010.pdf</a></p>
</li>
<li>
<p><a href="https://ctftime.org/writeup/7975">https://ctftime.org/writeup/7975</a></p>
</li>
<li>
<p><a href="https://ctftime.org/writeup/7974">https://ctftime.org/writeup/7974</a></p>
</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../../asymmetric/introduction/" class="btn btn-neutral float-right" title="非对称加密简介">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../ctr/" class="btn btn-neutral" title="CTR"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../ctr/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../../asymmetric/introduction/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../../..';</script>
    <script src="../../../../js/theme.js" defer></script>
      <script src="https://cdnjs.loli.net/ajax/libs/pangu/3.3.0/pangu.min.js" defer></script>
      <script src="../../../../_static/js/extra.js" defer></script>
      <script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
      <script src="../../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
