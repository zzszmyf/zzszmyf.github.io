<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../../../img/favicon.ico">
  <title>Nfsr zh - 西山下,闻溪语,书心境</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Nfsr zh";
    var mkdocs_page_input_path = "crypto/streamcipher/fsr/nfsr-zh.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../../.." class="icon icon-home"> 西山下,闻溪语,书心境</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../../../..">Index</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Crypto</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../introduction/">密码学简介</a>
                </li>
                <li class="">
                    
    <span class="caption-text">基础数学知识</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../basic/introduction/">简介</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">古典密码</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../classical/introduction/">古典密码简介</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../classical/monoalphabetic/">单表代换加密</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../classical/polyalphabetic/">多表代换加密</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../classical/others/">其他类型加密</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../classical/summary/">总结</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">流密码</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../intro/">介绍</a>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">伪随机数生成器</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../prng/intro/">介绍</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../prng/csprng/">密码学安全伪随机数生成器</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../prng/problem/">题目</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">线性同余生成器</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../lcg/intro/">简介</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../lcg/challenge/">例题</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">反馈移位寄存器</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../intro/">介绍</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../lfsr/">线性反馈移位寄存器</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../nfsr/">非线性反馈移位寄存器</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">特殊流密码</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../special/rc4/">RC4</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">块加密</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../blockcipher/introduction/">块加密简介</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../blockcipher/arx-operations/">ARX</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../blockcipher/des/">DES</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../blockcipher/idea/">IDEA</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../blockcipher/aes.md">AES</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../blockcipher/simon-speck/">Simon and Speck</a>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">分组模式</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/introduction/">介绍</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/padding/">填充方式</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/ecb/">ECB</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/cbc/">CBC</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/pcbc/">PCBC</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/cfb/">CFB</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/ofb/">OFB</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/ctr/">CTR</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/padding-oracle-attack/">Padding Oracle Attack</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">非对称加密</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../asymmetric/introduction/">非对称加密简介</a>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">RSA</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../asymmetric/rsa/rsa_theory/">RSA 基本介绍</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../asymmetric/rsa/rsa_module_attack/">模数相关攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../asymmetric/rsa/rsa_e_attack/">公钥指数相关攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../asymmetric/rsa/rsa_d_attack/">私钥 d 相关攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../asymmetric/rsa/rsa_coppersmith_attack.md">Coppersmith 相关攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../asymmetric/rsa/rsa_chosen_plain_cipher/">选择明密文攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../asymmetric/rsa/rsa_side_channel/">侧信道攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../asymmetric/rsa/rsa_pkcs_attack/">Bleichenbacher 攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../asymmetric/rsa/rsa_complex/">综合</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../asymmetric/knapsack/knapsack/">背包加密</a>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">离散对数相关</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../asymmetric/discrete-log/discrete-log/">离散对数</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../asymmetric/discrete-log/elgamal/">Elgamal</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../asymmetric/discrete-log/ecc/">ECC</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">格密码</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../asymmetric/lattice/overview/">格概述</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../asymmetric/lattice/introduction/">格介绍</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../asymmetric/lattice/lattice-reduction/">格基规约算法</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../asymmetric/lattice/cvp/">CVP</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">哈希函数</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../hash/introduction/">哈希函数简介</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../hash/md5/">MD5</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../hash/sha1/">SHA1</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../hash/fnv/">FNV</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../hash/attack/">Hash Attack</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../hash/complex/">综合</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">数字签名</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../signature/introduction/">数字签名简介</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../signature/rsa/">RSA 数字签名</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../signature/elgamal.md">ElGamal 数字签名</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../signature/dsa/">DSA 数字签名</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">攻击思想总结</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../attack-summary/attack-mode/">简介</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../attack-summary/meet-in-the-middle/">中间相遇攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../attack-summary/bit-attack/">比特攻击</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../../about/">About</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../..">西山下,闻溪语,书心境</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../..">Docs</a> &raquo;</li>
    
      
    
    <li>Nfsr zh</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p><a href="../nfsr/">EN</a> | <a href="./">ZH</a></p>
<h1 id="_1">非线性反馈移位寄存器</h1>
<h2 id="_2">介绍</h2>
<p>为了使得密钥流输出的序列尽可能复杂，会使用非线性反馈移位寄存器，常见的有三种</p>
<ul>
<li>非线性组合生成器，对多个 LFSR 的输出使用一个非线性组合函数</li>
<li>非线性滤波生成器，对一个 LFSR 的内容使用一个非线性组合函数</li>
<li>钟控生成器，使用一个（或多个）LFSR 的输出来控制另一个（或多个）LFSR 的时钟 </li>
</ul>
<h2 id="_3">非线性组合生成器</h2>
<h3 id="_4">简介</h3>
<p>组合生成器一般如下图所示。</p>
<p><img alt="image-20180713223743681" src="../figure/combine-generator.png" /></p>
<h3 id="geffe">Geffe</h3>
<p>这里我们以 Geffe 为例进行介绍。Geffe 包含 3 个线性反馈移位寄存器，非线性组合函数为</p>
<p>$F(x_1,x_2,x_3)=(x_1 \and x_2) \oplus (\urcorner x_1 \and x_3)=(x_1 \and x_2) \oplus ( x_1 \and x_3)\oplus x_3$</p>
<h4 id="2018-streamgame3">2018 强网杯 streamgame3</h4>
<p>简单看一下题目</p>
<pre><code class="python">from flag import flag
assert flag.startswith(&quot;flag{&quot;)
assert flag.endswith(&quot;}&quot;)
assert len(flag)==24

def lfsr(R,mask):
    output = (R &lt;&lt; 1) &amp; 0xffffff
    i=(R&amp;mask)&amp;0xffffff
    lastbit=0
    while i!=0:
        lastbit^=(i&amp;1)
        i=i&gt;&gt;1
    output^=lastbit
    return (output,lastbit)


def single_round(R1,R1_mask,R2,R2_mask,R3,R3_mask):
    (R1_NEW,x1)=lfsr(R1,R1_mask)
    (R2_NEW,x2)=lfsr(R2,R2_mask)
    (R3_NEW,x3)=lfsr(R3,R3_mask)
    return (R1_NEW,R2_NEW,R3_NEW,(x1*x2)^((x2^1)*x3))

R1=int(flag[5:11],16)
R2=int(flag[11:17],16)
R3=int(flag[17:23],16)
assert len(bin(R1)[2:])==17
assert len(bin(R2)[2:])==19
assert len(bin(R3)[2:])==21
R1_mask=0x10020
R2_mask=0x4100c
R3_mask=0x100002


for fi in range(1024):
    print fi
    tmp1mb=&quot;&quot;
    for i in range(1024):
        tmp1kb=&quot;&quot;
        for j in range(1024):
            tmp=0
            for k in range(8):
                (R1,R2,R3,out)=single_round(R1,R1_mask,R2,R2_mask,R3,R3_mask)
                tmp = (tmp &lt;&lt; 1) ^ out
            tmp1kb+=chr(tmp)
        tmp1mb+=tmp1kb
    f = open(&quot;./output/&quot; + str(fi), &quot;ab&quot;)
    f.write(tmp1mb)
    f.close()
</code></pre>

<p>可以看出，该程序与 Geffe 生成器非常类似，这里我们使用相关攻击方法进行攻击，我们可以统计一下在三个 LFSR 输出不同的情况下，最后类 Geffe 生成器的输出，如下</p>
<table>
<thead>
<tr>
<th>$x_1$</th>
<th>$x_2$</th>
<th>$x_3$</th>
<th>$F(x_1,x_2,x_3)$</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>可以发现</p>
<ul>
<li>Geffe 的输出与 $x_1$ 相同的概率为 0.75</li>
<li>Geffe 的输出与 $x_2$ 相同的概率为 0.5</li>
<li>Geffe 的输出与 $x_3$ 相同的概率为 0.75</li>
</ul>
<p>这说明输出与第一个和第三个的关联性非常大。 因此，我们可以暴力去枚举第一个和第三个 LFSR 的输出判断其与 类 Geffe 的输出相等的个数，如果大约在 75% 的话，就可以认为是正确的。第二个就直接暴力枚举了。</p>
<p>脚本如下</p>
<pre><code class="python">#for x1 in range(2):
#    for x2 in range(2):
#        for x3 in range(2):
#            print x1,x2,x3,(x1*x2)^((x2^1)*x3)
#n = [17,19,21]

#cycle = 1
#for i in n:
#    cycle = cycle*(pow(2,i)-1)
#print cycle


def lfsr(R, mask):
    output = (R &lt;&lt; 1) &amp; 0xffffff
    i = (R &amp; mask) &amp; 0xffffff
    lastbit = 0
    while i != 0:
        lastbit ^= (i &amp; 1)
        i = i &gt;&gt; 1
    output ^= lastbit
    return (output, lastbit)


def single_round(R1, R1_mask, R2, R2_mask, R3, R3_mask):
    (R1_NEW, x1) = lfsr(R1, R1_mask)
    (R2_NEW, x2) = lfsr(R2, R2_mask)
    (R3_NEW, x3) = lfsr(R3, R3_mask)
    return (R1_NEW, R2_NEW, R3_NEW, (x1 * x2) ^ ((x2 ^ 1) * x3))


R1_mask = 0x10020
R2_mask = 0x4100c
R3_mask = 0x100002
n3 = 21
n2 = 19
n1 = 17


def guess(beg, end, num, mask):
    ansn = range(beg, end)
    data = open('./output/0').read(num)
    data = ''.join(bin(256 + ord(c))[3:] for c in data)
    now = 0
    res = 0
    for i in ansn:
        r = i
        cnt = 0
        for j in range(num * 8):
            r, lastbit = lfsr(r, mask)
            lastbit = str(lastbit)
            cnt += (lastbit == data[j])
        if cnt &gt; now:
            now = cnt
            res = i
            print now, res
    return res


def bruteforce2(x, z):
    data = open('./output/0').read(50)
    data = ''.join(bin(256 + ord(c))[3:] for c in data)
    for y in range(pow(2, n2 - 1), pow(2, n2)):
        R1, R2, R3 = x, y, z
        flag = True
        for i in range(len(data)):
            (R1, R2, R3,
             out) = single_round(R1, R1_mask, R2, R2_mask, R3, R3_mask)
            if str(out) != data[i]:
                flag = False
                break
        if y % 10000 == 0:
            print 'now: ', x, y, z
        if flag:
            print 'ans: ', hex(x)[2:], hex(y)[2:], hex(z)[2:]
            break


R1 = guess(pow(2, n1 - 1), pow(2, n1), 40, R1_mask)
print R1
R3 = guess(pow(2, n3 - 1), pow(2, n3), 40, R3_mask)
print R3
R1 = 113099
R3 = 1487603

bruteforce2(R1, R3)
</code></pre>

<p>运行结果如下</p>
<pre><code class="shell">➜  2018-CISCN-start-streamgame3 git:(master) ✗ python exp.py
161 65536
172 65538
189 65545
203 65661
210 109191
242 113099
113099
157 1048576
165 1048578
183 1048580
184 1049136
186 1049436
187 1049964
189 1050869
190 1051389
192 1051836
194 1053573
195 1055799
203 1060961
205 1195773
212 1226461
213 1317459
219 1481465
239 1487603
1487603
now:  113099 270000 1487603
now:  113099 280000 1487603
now:  113099 290000 1487603
now:  113099 300000 1487603
now:  113099 310000 1487603
now:  113099 320000 1487603
now:  113099 330000 1487603
now:  113099 340000 1487603
now:  113099 350000 1487603
now:  113099 360000 1487603
ans:  1b9cb 5979c 16b2f3
</code></pre>

<p>从而 flag 为 flag{01b9cb05979c16b2f3}。</p>
<h2 id="_5">题目</h2>
<ul>
<li>2017 WHCTF Bornpig</li>
<li>2018 Google CTF 2018 Betterzip</li>
</ul>
<h2 id="_6">参考</h2>
<ul>
<li>https://www.rocq.inria.fr/secret/Anne.Canteaut/MPRI/chapter3.pdf</li>
<li>http://data.at.preempted.net/INDEX/articles/Correlation_Attacks_Geffe.pdf</li>
</ul>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '../../../..';</script>
    <script src="../../../../js/theme.js" defer></script>
      <script src="https://cdnjs.loli.net/ajax/libs/pangu/3.3.0/pangu.min.js" defer></script>
      <script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
      <script src="../../../../search/main.js" defer></script>

</body>
</html>
