<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../../../img/favicon.ico">
        <title>Rsa chosen plain cipher zh - 西山下,闻溪语,书心境</title>
        <link href="../../../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../../../..">西山下,闻溪语,书心境</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Index <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../../.." class="dropdown-item">首页</a>
</li>
                                    
<li>
    <a href="../../../../../about/" class="dropdown-item">关于我</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Crypto <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">ctf-wiki中的资料</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../introduction/" class="dropdown-item">密码学简介</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">基础数学知识</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../basic/introduction/" class="dropdown-item">简介</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">古典密码</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../classical/introduction/" class="dropdown-item">古典密码简介</a>
</li>
            
<li>
    <a href="../../../classical/monoalphabetic/" class="dropdown-item">单表代换加密</a>
</li>
            
<li>
    <a href="../../../classical/polyalphabetic/" class="dropdown-item">多表代换加密</a>
</li>
            
<li>
    <a href="../../../classical/others/" class="dropdown-item">其他类型加密</a>
</li>
            
<li>
    <a href="../../../classical/summary/" class="dropdown-item">总结</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">流密码</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../streamcipher/intro/" class="dropdown-item">介绍</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">伪随机数生成器</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../streamcipher/prng/intro/" class="dropdown-item">介绍</a>
</li>
            
<li>
    <a href="../../../streamcipher/prng/csprng/" class="dropdown-item">密码学安全伪随机数生成器</a>
</li>
            
<li>
    <a href="../../../streamcipher/prng/problem/" class="dropdown-item">题目</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">线性同余生成器</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../streamcipher/lcg/intro/" class="dropdown-item">简介</a>
</li>
            
<li>
    <a href="../../../streamcipher/lcg/challenge/" class="dropdown-item">例题</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">反馈移位寄存器</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../streamcipher/fsr/intro/" class="dropdown-item">介绍</a>
</li>
            
<li>
    <a href="../../../streamcipher/fsr/lfsr/" class="dropdown-item">线性反馈移位寄存器</a>
</li>
            
<li>
    <a href="../../../streamcipher/fsr/nfsr/" class="dropdown-item">非线性反馈移位寄存器</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">特殊流密码</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../streamcipher/special/rc4/" class="dropdown-item">RC4</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">块加密</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../blockcipher/introduction/" class="dropdown-item">块加密简介</a>
</li>
            
<li>
    <a href="../../../blockcipher/arx-operations/" class="dropdown-item">ARX</a>
</li>
            
<li>
    <a href="../../../blockcipher/des/" class="dropdown-item">DES</a>
</li>
            
<li>
    <a href="../../../blockcipher/idea/" class="dropdown-item">IDEA</a>
</li>
            
<li>
    <a href="../../../blockcipher/aes.md" class="dropdown-item">AES</a>
</li>
            
<li>
    <a href="../../../blockcipher/simon-speck/" class="dropdown-item">Simon and Speck</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">分组模式</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../blockcipher/mode/introduction/" class="dropdown-item">介绍</a>
</li>
            
<li>
    <a href="../../../blockcipher/mode/padding/" class="dropdown-item">填充方式</a>
</li>
            
<li>
    <a href="../../../blockcipher/mode/ecb/" class="dropdown-item">ECB</a>
</li>
            
<li>
    <a href="../../../blockcipher/mode/cbc/" class="dropdown-item">CBC</a>
</li>
            
<li>
    <a href="../../../blockcipher/mode/pcbc/" class="dropdown-item">PCBC</a>
</li>
            
<li>
    <a href="../../../blockcipher/mode/cfb/" class="dropdown-item">CFB</a>
</li>
            
<li>
    <a href="../../../blockcipher/mode/ofb/" class="dropdown-item">OFB</a>
</li>
            
<li>
    <a href="../../../blockcipher/mode/ctr/" class="dropdown-item">CTR</a>
</li>
            
<li>
    <a href="../../../blockcipher/mode/padding-oracle-attack/" class="dropdown-item">Padding Oracle Attack</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">非对称加密</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../introduction/" class="dropdown-item">非对称加密简介</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">RSA</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../rsa_theory/" class="dropdown-item">RSA 基本介绍</a>
</li>
            
<li>
    <a href="../rsa_module_attack/" class="dropdown-item">模数相关攻击</a>
</li>
            
<li>
    <a href="../rsa_e_attack/" class="dropdown-item">公钥指数相关攻击</a>
</li>
            
<li>
    <a href="../rsa_d_attack/" class="dropdown-item">私钥 d 相关攻击</a>
</li>
            
<li>
    <a href="../rsa_coppersmith_attack.md" class="dropdown-item">Coppersmith 相关攻击</a>
</li>
            
<li>
    <a href="../rsa_chosen_plain_cipher/" class="dropdown-item">选择明密文攻击</a>
</li>
            
<li>
    <a href="../rsa_side_channel/" class="dropdown-item">侧信道攻击</a>
</li>
            
<li>
    <a href="../rsa_pkcs_attack/" class="dropdown-item">Bleichenbacher 攻击</a>
</li>
            
<li>
    <a href="../rsa_complex/" class="dropdown-item">综合</a>
</li>
    </ul>
  </li>
            
<li>
    <a href="../../knapsack/knapsack/" class="dropdown-item">背包加密</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">离散对数相关</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../discrete-log/discrete-log/" class="dropdown-item">离散对数</a>
</li>
            
<li>
    <a href="../../discrete-log/elgamal/" class="dropdown-item">Elgamal</a>
</li>
            
<li>
    <a href="../../discrete-log/ecc/" class="dropdown-item">ECC</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">格密码</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../lattice/overview/" class="dropdown-item">格概述</a>
</li>
            
<li>
    <a href="../../lattice/introduction/" class="dropdown-item">格介绍</a>
</li>
            
<li>
    <a href="../../lattice/lattice-reduction/" class="dropdown-item">格基规约算法</a>
</li>
            
<li>
    <a href="../../lattice/cvp/" class="dropdown-item">CVP</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">哈希函数</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../hash/introduction/" class="dropdown-item">哈希函数简介</a>
</li>
            
<li>
    <a href="../../../hash/md5/" class="dropdown-item">MD5</a>
</li>
            
<li>
    <a href="../../../hash/sha1/" class="dropdown-item">SHA1</a>
</li>
            
<li>
    <a href="../../../hash/fnv/" class="dropdown-item">FNV</a>
</li>
            
<li>
    <a href="../../../hash/attack/" class="dropdown-item">Hash Attack</a>
</li>
            
<li>
    <a href="../../../hash/complex/" class="dropdown-item">综合</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">数字签名</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../signature/introduction/" class="dropdown-item">数字签名简介</a>
</li>
            
<li>
    <a href="../../../signature/rsa/" class="dropdown-item">RSA 数字签名</a>
</li>
            
<li>
    <a href="../../../signature/elgamal.md" class="dropdown-item">ElGamal 数字签名</a>
</li>
            
<li>
    <a href="../../../signature/dsa/" class="dropdown-item">DSA 数字签名</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">攻击思想总结</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../attack-summary/attack-mode/" class="dropdown-item">简介</a>
</li>
            
<li>
    <a href="../../../attack-summary/meet-in-the-middle/" class="dropdown-item">中间相遇攻击</a>
</li>
            
<li>
    <a href="../../../attack-summary/bit-attack/" class="dropdown-item">比特攻击</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../../../../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#rsa" class="nav-link">RSA 选择明密文攻击</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#_1" class="nav-link">选择明文攻击</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_2" class="nav-link">任意密文解密</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#rsa-parity-oracle" class="nav-link">RSA parity oracle</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#rsa-byte-oracle" class="nav-link">RSA Byte Oracle</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_6" class="nav-link">参考</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p><a href="../rsa_chosen_plain_cipher/">EN</a> | <a href="./">ZH</a></p>
<h1 id="rsa">RSA 选择明密文攻击<a class="headerlink" href="#rsa" title="Permanent link">&para;</a></h1>
<h2 id="_1">选择明文攻击<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>这里给出一个例子，假如我们有一个加密 oracle ，但是我们不知道 n 和 e，那</p>
<ol>
<li>我们可以通过加密 oracle 获取 n。</li>
<li>在 e 比较小（ <span><span class="MathJax_Preview">e&lt;2^{64}</span><script type="math/tex">e<2^{64}</script></span>）时，我们可以利用 <em>Pollard’s kangaroo algorithm</em> 算法获取 e。这一点比较显然。</li>
</ol>
<p>我们可以加密 2，4，8，16。那么我们可以知道</p>
<p><span><span class="MathJax_Preview">c_2=2^{e} \bmod n</span><script type="math/tex">c_2=2^{e} \bmod n</script></span></p>
<p><span><span class="MathJax_Preview">c_4=4^{e} \bmod n</span><script type="math/tex">c_4=4^{e} \bmod n</script></span></p>
<p><span><span class="MathJax_Preview">c_8=8^{e} \bmod n</span><script type="math/tex">c_8=8^{e} \bmod n</script></span></p>
<p>那么</p>
<p><span><span class="MathJax_Preview">c_2^2 \equiv c_4 \bmod n</span><script type="math/tex">c_2^2 \equiv c_4 \bmod n</script></span></p>
<p><span><span class="MathJax_Preview">c_2^3 \equiv c_8 \bmod n</span><script type="math/tex">c_2^3 \equiv c_8 \bmod n</script></span></p>
<p>故而</p>
<p><span><span class="MathJax_Preview">c_2^2-c_4=kn</span><script type="math/tex">c_2^2-c_4=kn</script></span></p>
<p><span><span class="MathJax_Preview">c_2^3-c_8=tn</span><script type="math/tex">c_2^3-c_8=tn</script></span></p>
<p>我们可以求出 kn 和 tn 的最大公因数，很大概率就是 n 了。我们还可以构造更多的例子从来更加确定性地找 n。</p>
<h2 id="_2">任意密文解密<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>假设爱丽丝创建了密文 <span><span class="MathJax_Preview">C = P^e \bmod n</span><script type="math/tex">C = P^e \bmod n</script></span> 并且把 C 发送给鲍勃，同时假设我们要对爱丽丝加密后的任意密文解密，而不是只解密 C，那么我们可以拦截 C，并运用下列步骤求出 P：</p>
<ol>
<li>选择任意的 <span><span class="MathJax_Preview">X\in Z_n^{*}</span><script type="math/tex">X\in Z_n^{*}</script></span>，即 X 与 N 互素</li>
<li>计算 <span><span class="MathJax_Preview">Y=C \times X^e \bmod n</span><script type="math/tex">Y=C \times X^e \bmod n</script></span> </li>
<li>由于我们可以进行选择密文攻击，那么我们求得 Y 对应的解密结果 <span><span class="MathJax_Preview">Z=Y^d</span><script type="math/tex">Z=Y^d</script></span></li>
<li>那么，由于 <span><span class="MathJax_Preview">Z=Y^d=(C \times X^e)^d=C^d X=P^{ed} X= P X\bmod n</span><script type="math/tex">Z=Y^d=(C \times X^e)^d=C^d X=P^{ed} X= P X\bmod n</script></span>，由于 X 与 N 互素，我们很容易求得相应的逆元，进而可以得到 P</li>
</ol>
<h2 id="rsa-parity-oracle">RSA parity oracle<a class="headerlink" href="#rsa-parity-oracle" title="Permanent link">&para;</a></h2>
<p>假设目前存在一个 Oracle，它会对一个给定的密文进行解密，并且会检查解密的明文的奇偶性，并根据奇偶性返回相应的值，比如 1 表示奇数，0 表示偶数。那么给定一个加密后的密文，我们只需要 log(N) 次就可以知道这个密文对应的明文消息。</p>
<h3 id="_3">原理<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>假设</p>
<p><span><span class="MathJax_Preview">C=P^e \bmod N</span><script type="math/tex">C=P^e \bmod N</script></span></p>
<p>第一次时，我们可以给服务器发送</p>
<p><span><span class="MathJax_Preview">C*2^e=(2P)^e \bmod N</span><script type="math/tex">C*2^e=(2P)^e \bmod N</script></span></p>
<p>服务器会计算得到</p>
<p><span><span class="MathJax_Preview">2P \bmod N</span><script type="math/tex">2P \bmod N</script></span></p>
<p>这里</p>
<ul>
<li>2P 是偶数，它的幂次也是偶数。</li>
<li>N 是奇数，因为它是由两个大素数相乘得到。</li>
</ul>
<p>那么</p>
<ul>
<li>服务器返回奇数，即 <span><span class="MathJax_Preview">2P \bmod N</span><script type="math/tex">2P \bmod N</script></span> 为奇数，则说明 2P 大于 N，且减去了奇数个 N，又因为 <span><span class="MathJax_Preview">2P&lt;2N</span><script type="math/tex">2P<2N</script></span>，因此减去了一个N， 即 <span><span class="MathJax_Preview">\frac{N}{2} \leq P &lt; N</span><script type="math/tex">\frac{N}{2} \leq P < N</script></span>，我们还可以考虑向下取整。</li>
<li>服务器返回偶数，则说明 2P 小于 N。即 <span><span class="MathJax_Preview">0\leq P &lt; \frac{N}{2}</span><script type="math/tex">0\leq P < \frac{N}{2}</script></span>，我们还可以向下取整。</li>
</ul>
<p>这里我们使用数学归纳法，即假设在第 i 次时，<span><span class="MathJax_Preview">\frac{xN}{2^{i}} \leq P &lt; \frac{xN+N}{2^{i}}</span><script type="math/tex">\frac{xN}{2^{i}} \leq P < \frac{xN+N}{2^{i}}</script></span></p>
<p>进一步，在第 i+1 次时，我们可以发送</p>
<p><span><span class="MathJax_Preview">C*2^{(i+1)e}</span><script type="math/tex">C*2^{(i+1)e}</script></span></p>
<p>服务器会计算得到</p>
<p><span><span class="MathJax_Preview">2^{i+1}P \bmod N=2^{i+1}P-kN</span><script type="math/tex">2^{i+1}P \bmod N=2^{i+1}P-kN</script></span></p>
<p><span><span class="MathJax_Preview">0 \leq 2^{i+1}P-kN&lt;N</span><script type="math/tex">0 \leq 2^{i+1}P-kN<N</script></span> </p>
<p><span><span class="MathJax_Preview">\frac{kN}{2^{i+1}} \leq P &lt; \frac{kN+N}{2^{i+1}}</span><script type="math/tex">\frac{kN}{2^{i+1}} \leq P < \frac{kN+N}{2^{i+1}}</script></span></p>
<p>根据第 i 次的结果</p>
<p><span><span class="MathJax_Preview">\frac{2xN}{2^{i+1}} \leq P &lt; \frac{2xN+2N}{2^{i+1}}</span><script type="math/tex">\frac{2xN}{2^{i+1}} \leq P < \frac{2xN+2N}{2^{i+1}}</script></span></p>
<p>那么</p>
<ul>
<li>服务器返回奇数，则 k 必然是一个奇数，k=2y+1， 那么 <span><span class="MathJax_Preview">\frac{2yN+N}{2^{i+1}} \leq P &lt; \frac{2yN+2N}{2^{i+1}}</span><script type="math/tex">\frac{2yN+N}{2^{i+1}} \leq P < \frac{2yN+2N}{2^{i+1}}</script></span>。与此同时，由于 P 必然存在，所以第 i+1 得到的这个范围和第 i 次得到的范围必然存在交集。所以 y 必然与 x 相等。</li>
<li>服务器返回偶数，则 k 必然是一个偶数，k=2y，此时 y 必然也与 x 相等，那么 <span><span class="MathJax_Preview">\frac{2xN}{2^{i+1}} \leq P &lt; \frac{2xN+N}{2^{i+1}}</span><script type="math/tex">\frac{2xN}{2^{i+1}} \leq P < \frac{2xN+N}{2^{i+1}}</script></span></li>
</ul>
<p>进一步我们可以这么归纳</p>
<div class="highlight"><pre><span></span><code><span class="n">lb</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ub</span> <span class="o">=</span> <span class="n">N</span>
<span class="k">if</span> <span class="n">server</span> <span class="n">returns</span> <span class="mi">1</span>
    <span class="n">lb</span> <span class="o">=</span> <span class="p">(</span><span class="n">lb</span><span class="o">+</span><span class="n">ub</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="k">else</span><span class="o">:</span>
    <span class="n">ub</span> <span class="o">=</span> <span class="p">(</span><span class="n">lb</span><span class="o">+</span><span class="n">ub</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</code></pre></div>

<p>这里虽然是整除， 即下取整，但是无所谓我们在最初时已经分析了这个问题。</p>
<h3 id="2018-google-ctf-perfect-secrecy">2018 Google CTF Perfect Secrecy<a class="headerlink" href="#2018-google-ctf-perfect-secrecy" title="Permanent link">&para;</a></h3>
<p>这里以 2018 年 Google CTF 的题目为例进行分析</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">serialization</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>


<span class="k">def</span> <span class="nf">ReadPrivateKey</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span>
      <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">RsaDecrypt</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">):</span>
  <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span> <span class="o">&lt;=</span>
          <span class="p">(</span><span class="n">private_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span><span class="o">.</span><span class="n">key_size</span> <span class="o">//</span> <span class="mi">8</span><span class="p">)),</span> <span class="s1">&#39;Ciphertext too large&#39;</span>
  <span class="k">return</span> <span class="nb">pow</span><span class="p">(</span>
      <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">),</span>
      <span class="n">private_key</span><span class="o">.</span><span class="n">private_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">d</span><span class="p">,</span>
      <span class="n">private_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">Challenge</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">m0</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">private_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span><span class="o">.</span><span class="n">key_size</span> <span class="o">//</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">dice</span> <span class="o">=</span> <span class="n">RsaDecrypt</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">rounds</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
      <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">][</span><span class="n">dice</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">]</span>
      <span class="n">k</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
      <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
      <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">((</span><span class="n">c</span><span class="p">,)))</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">0</span>

  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="n">private_key</span> <span class="o">=</span> <span class="n">ReadPrivateKey</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">Challenge</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>

<p>可以看出</p>
<ul>
<li>我们可以给服务器两个数，服务器会根据解密后的密文内容来决定使用哪一个。</li>
<li>服务器会使用 <code>random.randint(0, 2)</code> 来生成随机数，并输出相关的随机 01 字节 c。</li>
</ul>
<p>乍一看，似乎是完全随机的，仔细查一下 <code>random.randint(0, 2)</code> 可以知道其生成随机数是包括边界的，因此其生成偶数的概率大于生成奇数的概率，那么 c 与 p 同奇偶的概率为 &#8532;。进而我们通过设置 m0 和 m1 就可以知道解密后的密文的最后一位是 0 还是 1 。这其实就是 RSA parity oracle。</p>
<p>exp 如下</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">gmpy2</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">encflag</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./flag.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">encflag</span> <span class="o">=</span> <span class="n">encflag</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
<span class="n">encflag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">encflag</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
<span class="c1">#context.log_level = &#39;debug&#39;</span>
<span class="n">m</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x07</span><span class="s1">&#39;</span><span class="p">]</span>
<span class="n">n</span> <span class="o">=</span> <span class="mh">0xDA53A899D5573091AF6CC9C9A9FC315F76402C8970BBB1986BFE8E29CED12D0ADF61B21D6C281CCBF2EFED79AA7DD23A2776B03503B1AF354E35BF58C91DB7D7C62F6B92C918C90B68859C77CAE9FDB314F82490A0D6B50C5DC85F5C92A6FDF19716AC8451EFE8BBDF488AE098A7C76ADD2599F2CA642073AFA20D143AF403D1</span>
<span class="n">e</span> <span class="o">=</span> <span class="mi">65537</span>
<span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>



<span class="k">def</span> <span class="nf">guessvalue</span><span class="p">(</span><span class="n">cnt</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cnt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cnt</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="mi">1</span>


<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">cnt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;perfect-secrecy.ctfcompetition.com&#39;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">two_inv</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">two_cipher</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">powmod</span><span class="p">(</span><span class="n">two_inv</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">encflag</span> <span class="o">*</span> <span class="n">two_cipher</span> <span class="o">%</span> <span class="n">n</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">tmp</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">256</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span> <span class="o">+</span> <span class="n">tmp</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">128</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="c1">#print tmp</span>
    <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">100</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">+=</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">cnt</span><span class="p">[</span><span class="n">u8</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">guessvalue</span><span class="p">(</span><span class="n">cnt</span><span class="p">))</span> <span class="o">+</span> <span class="n">flag</span>
    <span class="nb">print</span> <span class="n">i</span><span class="p">,</span> <span class="n">flag</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>

<p>结果如下</p>
<div class="highlight"><pre><span></span><code><span class="m">6533021797450432625003726192285181680054061843303961161444459679874621880787893445342698029728203298974356255732086344166897556918532195998159983477294838449903429031335408290610431938507208444225296242342845578895553611385588996615744823221415296689514934439749745119968629875229882861818946483594948270</span> <span class="m">6533021797450432625003726192285181680054061843303961161444459679874621880787893445342698029728203298974356255732086344166897556918532195998159983477294838449903429031335408290610431938507208444225296242342845578895553611385588996615744823221415296689514934439749745119968629875229882861818946483594948270</span>
</code></pre></div>

<p>解码后就可以得到 flag</p>
<div class="highlight"><pre><span></span><code>CTF<span class="o">{</span>h3ll0__17_5_m3_1_w45_w0nd3r1n6_1f_4f73r_4ll_7h353_y34r5_y0u_d_l1k3_70_m337<span class="o">}</span>
</code></pre></div>

<h3 id="_4">题目<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<ul>
<li>2016 Plaid CTF rabit</li>
<li>2016 sharif CTF lsb-oracle-150</li>
<li>2018 Backdoor CTF  BIT-LEAKER</li>
<li>2018 XMAN 选拔赛 baby RSA</li>
</ul>
<h2 id="rsa-byte-oracle">RSA Byte Oracle<a class="headerlink" href="#rsa-byte-oracle" title="Permanent link">&para;</a></h2>
<p>假设目前存在一个 Oracle，它会对一个给定的密文进行解密，并且会给出明文的最后一个字节。那么给定一个加密后的密文，我们只需要 <span><span class="MathJax_Preview">\log_{256}n</span><script type="math/tex">\log_{256}n</script></span> 次就可以知道这个密文对应的明文消息。</p>
<h3 id="_5">原理<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>这个其实算作 RSA parity Oracle 的扩展，既然可以泄露出最后一个字节，那么按道理我们获取密文对应明文的次数应该可以减少。</p>
<p>假设</p>
<p><span><span class="MathJax_Preview">C=P^e \bmod N</span><script type="math/tex">C=P^e \bmod N</script></span></p>
<p>第一次时，我们可以给服务器发送</p>
<p><span><span class="MathJax_Preview">C*256^e=(256P)^e \bmod N</span><script type="math/tex">C*256^e=(256P)^e \bmod N</script></span></p>
<p>服务器会计算得到</p>
<p><span><span class="MathJax_Preview">256P \bmod N</span><script type="math/tex">256P \bmod N</script></span></p>
<p>这里</p>
<ul>
<li>256P 是偶数。</li>
<li>N 是奇数，因为它是由两个大素数相乘得到。</li>
</ul>
<p>由于 P 一般是小于 N 的，那么<span><span class="MathJax_Preview">256P \bmod N=256P-kn, k&lt;256</span><script type="math/tex">256P \bmod N=256P-kn, k<256</script></span>。而且对于两个不同的 <span><span class="MathJax_Preview">k_1,k_2</span><script type="math/tex">k_1,k_2</script></span>，我们有</p>
<p><span><span class="MathJax_Preview">256P-k_1n \not\equiv 256P-k_2n \bmod 256</span><script type="math/tex">256P-k_1n \not\equiv 256P-k_2n \bmod 256</script></span></p>
<p>我们可以利用反证法来证明上述不等式。同时 <span><span class="MathJax_Preview">256P-kn</span><script type="math/tex">256P-kn</script></span> 的最后一个字节其实就是 <span><span class="MathJax_Preview">-kn</span><script type="math/tex">-kn</script></span> 在模 256 的情况下获取的。那么，其实我们可以首先枚举出 0~255 情况下的最后一个字节，构造一个 k 和最后一个字节的映射表 map</p>
<p>当服务器返回最后一个字节 b，那么我们可以根据上述构造的映射表得知 k，即减去了 k 个N， 即 <span><span class="MathJax_Preview">kN \leq 256 P \leq (k+1)N</span><script type="math/tex">kN \leq 256 P \leq (k+1)N</script></span>。</p>
<p>此后，我们使用数学归纳法来获取 P 的范围，即假设在第 i 次时，<span><span class="MathJax_Preview">\frac{xN}{256^{i}} \leq P &lt; \frac{xN+N}{256^{i}}</span><script type="math/tex">\frac{xN}{256^{i}} \leq P < \frac{xN+N}{256^{i}}</script></span></p>
<p>进一步，在第 i+1 次时，我们可以发送</p>
<p><span><span class="MathJax_Preview">C*256^{(i+1)e}</span><script type="math/tex">C*256^{(i+1)e}</script></span></p>
<p>服务器会计算得到</p>
<p><span><span class="MathJax_Preview">256^{i+1}P \bmod N=256^{i+1}P-kN</span><script type="math/tex">256^{i+1}P \bmod N=256^{i+1}P-kN</script></span></p>
<p><span><span class="MathJax_Preview">0 \leq 256^{i+1}P-kN&lt;N</span><script type="math/tex">0 \leq 256^{i+1}P-kN<N</script></span> </p>
<p><span><span class="MathJax_Preview">\frac{kN}{256^{i+1}} \leq P &lt; \frac{kN+N}{256^{i+1}}</span><script type="math/tex">\frac{kN}{256^{i+1}} \leq P < \frac{kN+N}{256^{i+1}}</script></span></p>
<p>根据第 i 次的结果</p>
<p><span><span class="MathJax_Preview">\frac{256xN}{256^{i+1}} \leq P &lt; \frac{256xN+256N}{256^{i+1}}</span><script type="math/tex">\frac{256xN}{256^{i+1}} \leq P < \frac{256xN+256N}{256^{i+1}}</script></span></p>
<p>我们这里可以假设 <span><span class="MathJax_Preview">k=256y+t</span><script type="math/tex">k=256y+t</script></span>， 而这里的 t 就是我们可以通过映射表获取的。</p>
<p><span><span class="MathJax_Preview">\frac{256yN+tN}{256^{i+1}} \leq P &lt; \frac{256yN+(t+1)N}{256^{i+1}}</span><script type="math/tex">\frac{256yN+tN}{256^{i+1}} \leq P < \frac{256yN+(t+1)N}{256^{i+1}}</script></span></p>
<p>与此同时，由于 P 必然存在，所以第 i+1 得到的这个范围和第 i 次得到的范围必然存在交集。</p>
<p>所以 y 必然与 x 相等。</p>
<p>进一步我们可以这么归纳，初始情况下</p>
<div class="highlight"><pre><span></span><code>lb = 0
ub = N
</code></pre></div>

<p>假设服务器返回了 b，那么</p>
<div class="highlight"><pre><span></span><code><span class="n">k</span> <span class="o">=</span> <span class="n">mab</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
<span class="n">interval</span> <span class="o">=</span> <span class="p">(</span><span class="n">ub</span><span class="o">-</span><span class="n">lb</span><span class="p">)</span><span class="o">/</span><span class="mi">256</span>
<span class="n">lb</span> <span class="o">=</span> <span class="n">lb</span> <span class="o">+</span> <span class="n">interval</span> <span class="o">*</span> <span class="n">k</span>
<span class="n">ub</span> <span class="o">=</span> <span class="n">lb</span> <span class="o">+</span> <span class="n">interval</span>
</code></pre></div>

<h3 id="2018-hitcon-lost-key">2018 HITCON lost key<a class="headerlink" href="#2018-hitcon-lost-key" title="Permanent link">&para;</a></h3>
<p>这是一个综合题目，首先没有给出 n，我们可以使用选择明文攻击的方式获取 n，当然我们也可以进一步获取 e，最后利用代码如下</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">gmpy2</span>
<span class="kn">from</span> <span class="nn">fractions</span> <span class="kn">import</span> <span class="n">Fraction</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./rsa.py&#39;</span><span class="p">)</span>
<span class="c1">#p = remote(&#39;18.179.251.168&#39;, 21700)</span>
<span class="c1">#context.log_level = &#39;debug&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Here is the flag!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">flagcipher</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">long_to_hex</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">n</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;cmd: &#39;</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;input: &#39;</span><span class="p">,</span> <span class="n">long_to_hex</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># get n</span>
    <span class="n">cipher2</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">cipher4</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">nset</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cipher2</span> <span class="o">*</span> <span class="n">cipher2</span> <span class="o">-</span> <span class="n">cipher4</span><span class="p">)</span>

    <span class="n">cipher3</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">cipher9</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
    <span class="n">nset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cipher3</span> <span class="o">*</span> <span class="n">cipher3</span> <span class="o">-</span> <span class="n">cipher9</span><span class="p">)</span>
    <span class="n">cipher5</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">cipher25</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
    <span class="n">nset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cipher5</span> <span class="o">*</span> <span class="n">cipher5</span> <span class="o">-</span> <span class="n">cipher25</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">nset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">nset</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">gcd</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="c1"># get map between k and return byte</span>
    <span class="n">submap</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">):</span>
        <span class="n">submap</span><span class="p">[</span><span class="o">-</span><span class="n">n</span> <span class="o">*</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

    <span class="c1"># get cipher256</span>
    <span class="n">cipher256</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>

    <span class="n">back</span> <span class="o">=</span> <span class="n">flagcipher</span>

    <span class="n">L</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">i</span>
        <span class="n">flagcipher</span> <span class="o">=</span> <span class="n">flagcipher</span> <span class="o">*</span> <span class="n">cipher256</span> <span class="o">%</span> <span class="n">n</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">flagcipher</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">submap</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
        <span class="n">L</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">L</span> <span class="o">+</span> <span class="p">(</span><span class="n">R</span> <span class="o">-</span> <span class="n">L</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">256</span>
                                     <span class="p">),</span> <span class="n">L</span> <span class="o">+</span> <span class="p">(</span><span class="n">R</span> <span class="o">-</span> <span class="n">L</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
    <span class="n">low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">L</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">long_to_hex</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="n">low</span> <span class="o">%</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">send</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">back</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_6">参考<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://crypto.stackexchange.com/questions/11053/rsa-least-significant-bit-oracle-attack">https://crypto.stackexchange.com/questions/11053/rsa-least-significant-bit-oracle-attack</a></li>
<li><a href="https://pastebin.com/KnEUSMxp">https://pastebin.com/KnEUSMxp</a></li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../../../js/base.js" defer></script>
        <script src="https://cdnjs.loli.net/ajax/libs/pangu/3.3.0/pangu.min.js" defer></script>
        <script src="../../../../../_static/js/extra.js" defer></script>
        <script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
        <script src="../../../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
