<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>Hash Attack - 西山下,闻溪语,书心境</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Hash Attack";
    var mkdocs_page_input_path = "crypto/hash/attack.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> 西山下,闻溪语,书心境</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../../..">Index</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Crypto</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../introduction/">密码学简介</a>
                </li>
                <li class="">
                    
    <span class="caption-text">基础数学知识</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../basic/introduction/">简介</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">古典密码</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../classical/introduction/">古典密码简介</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../classical/monoalphabetic/">单表代换加密</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../classical/polyalphabetic/">多表代换加密</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../classical/others/">其他类型加密</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../classical/summary/">总结</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">流密码</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../streamcipher/intro/">介绍</a>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">伪随机数生成器</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../streamcipher/prng/intro/">介绍</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../streamcipher/prng/csprng/">密码学安全伪随机数生成器</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../streamcipher/prng/problem/">题目</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">线性同余生成器</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../streamcipher/lcg/intro/">简介</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../streamcipher/lcg/challenge/">例题</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">反馈移位寄存器</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../streamcipher/fsr/intro/">介绍</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../streamcipher/fsr/lfsr/">线性反馈移位寄存器</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../streamcipher/fsr/nfsr/">非线性反馈移位寄存器</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">特殊流密码</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../streamcipher/special/rc4/">RC4</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">块加密</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../blockcipher/introduction/">块加密简介</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../blockcipher/arx-operations/">ARX</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../blockcipher/des/">DES</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../blockcipher/idea/">IDEA</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../blockcipher/aes.md">AES</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../blockcipher/simon-speck/">Simon and Speck</a>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">分组模式</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../blockcipher/mode/introduction/">介绍</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../blockcipher/mode/padding/">填充方式</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../blockcipher/mode/ecb/">ECB</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../blockcipher/mode/cbc/">CBC</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../blockcipher/mode/pcbc/">PCBC</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../blockcipher/mode/cfb/">CFB</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../blockcipher/mode/ofb/">OFB</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../blockcipher/mode/ctr/">CTR</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../blockcipher/mode/padding-oracle-attack/">Padding Oracle Attack</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class=" current">
                    
    <span class="caption-text">非对称加密</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../asymmetric/introduction/">非对称加密简介</a>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">RSA</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../asymmetric/rsa/rsa_theory/">RSA 基本介绍</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../asymmetric/rsa/rsa_module_attack/">模数相关攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../asymmetric/rsa/rsa_e_attack/">公钥指数相关攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../asymmetric/rsa/rsa_d_attack/">私钥 d 相关攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../asymmetric/rsa/rsa_coppersmith_attack.md">Coppersmith 相关攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../asymmetric/rsa/rsa_chosen_plain_cipher/">选择明密文攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../asymmetric/rsa/rsa_side_channel/">侧信道攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../asymmetric/rsa/rsa_pkcs_attack/">Bleichenbacher 攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../asymmetric/rsa/rsa_complex/">综合</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../asymmetric/knapsack/knapsack/">背包加密</a>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">离散对数相关</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../asymmetric/discrete-log/discrete-log/">离散对数</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../asymmetric/discrete-log/elgamal/">Elgamal</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../asymmetric/discrete-log/ecc/">ECC</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">格密码</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../asymmetric/lattice/overview/">格概述</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../asymmetric/lattice/introduction/">格介绍</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../asymmetric/lattice/lattice-reduction/">格基规约算法</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../asymmetric/lattice/cvp/">CVP</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3 current">
                    
    <span class="caption-text">哈希函数</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../introduction/">哈希函数简介</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../md5/">MD5</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../sha1/">SHA1</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../fnv/">FNV</a>
                </li>
                <li class="toctree-l4 current">
                    
    <a class="current" href="./">Hash Attack</a>
    <ul class="subnav">
            
    <li class="toctree-l5"><a href="#hash-attack">Hash Attack</a></li>
    
        <ul>
        
            <li><a class="toctree-l6" href="#violent-attack">violent attack</a></li>
        
            <li><a class="toctree-l6" href="#hash-length-extension-attacks">hash length extension attacks</a></li>
        
            <li><a class="toctree-l6" href="#hash-algorithm-is-incorrectly-designed">hash algorithm is incorrectly designed</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../complex/">综合</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">数字签名</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../signature/introduction/">数字签名简介</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../signature/rsa/">RSA 数字签名</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../signature/elgamal.md">ElGamal 数字签名</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../signature/dsa/">DSA 数字签名</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">攻击思想总结</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../attack-summary/attack-mode/">简介</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../attack-summary/meet-in-the-middle/">中间相遇攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../attack-summary/bit-attack/">比特攻击</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../about/">About</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">西山下,闻溪语,书心境</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>哈希函数 &raquo;</li>
        
      
        
          <li>非对称加密 &raquo;</li>
        
      
        
          <li>Crypto &raquo;</li>
        
      
    
    <li>Hash Attack</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p><a href="./">EN</a> | <a href="../attack-zh/">ZH</a></p>
<h1 id="hash-attack">Hash Attack</h1>
<p>Common hash function attack methods are mainly</p>
<ul>
<li>Violent attack: does not depend on any algorithm details, only related to the length of the hash value;</li>
<li>Birthday Attack: The structure and any algebraic weak nature of the hash function are not used, depending only on the length of the message digest, which is the length of the hash value.</li>
<li>Meet-In-The-Middle: It is a variant of a birthday attack. Instead of comparing hash values, it compares intermediate variables. This type of attack is mainly used to attack Hash schemes with a packet chain structure.</li>
<li>Password analysis: Depends on the design shortcomings of specific algorithms.</li>
</ul>
<h2 id="violent-attack">violent attack</h2>
<p><strong>HashCat tool</strong> can be said to be the best CPU and GPU-based cracking Hash software, the related links are as follows</p>
<p>[HashCat official website] (http://www.hashcat.net/hashcat/)</p>
<p>[HashCat Simple to use] (http://www.freebuf.com/sectool/112479.html)</p>
<h2 id="hash-length-extension-attacks">hash length extension attacks</h2>
<h3 id="introduction">Introduction</h3>
<p>The basic definition is as follows, from [Wikipedia] (https://en.wikipedia.org/wiki/%E9%95%BF%E5%BA%A6%E6%89%A9%E5%B1%95%E6% 94% BB% E5% 87% BB).</p>
<p>Hash Length Extension Attacks are pointers to certain cryptographic hash functions that allow additional information. This attack applies to all hash functions that take the H(key ∥ message) construct in the case where the length of the <strong> message and the key is known</strong>. Algorithms based on the Merkle–Damgård constructs such as MD5 and SHA-1 show vulnerabilities to such attacks.</p>
<p>This type of hash function has the following characteristics</p>
<ul>
<li>The message padding method is similar. First, add a 1 after the message, then fill in a number of 0s until the total length is congruent with 448, and finally attach a 64-bit message length (before filling).</li>
<li>Each link variable obtained will be used as the initial vector IV for the next execution of the hash function. In the last block, the corresponding link variable will be converted to a hash value.</li>
</ul>
<p>The following conditions should be met during a general attack.</p>
<ul>
<li>We know the length of the key, if you don&#39;t know, you need to burst it out.</li>
<li>We can control the message of the message.</li>
<li>We already know the hash value of a message containing a key.</li>
</ul>
<p>So we can get a pair (messge, x) to satisfy x = H (key ∥ message) although we are not sure about the contents of the key.</p>
<h3 id="attack-principle">Attack principle</h3>
<p>Here we can assume that we know the hash value of hash(key+s), where s is known, then it will be filled when it is calculated. Then we can first get the key+s extended by key+s, ie</p>
<p>now=key|s|padding</p>
<p>Then if we attach a part of the information extra after the now, ie</p>
<p>key|s|padding|extra</p>
<p>When you go to calculate the hash value,</p>
<ol>
<li>The extra is filled until the condition is met.</li>
<li>Calculate the link variable IV1 corresponding to now, and we already know the hash value of this part, and the algorithm that the link variable produces the hash value is reversible, so we can get the link variable.</li>
<li>The hash algorithm is performed on the extra part according to the obtained link variable IV1, and the hash value is returned.</li>
</ol>
<p>So now that we know the hash value of the first part, and we also know the value of extra, then we can get the last hash value.</p>
<p>And before we said that we can control the value of the message. So in fact, s, padding, extra, we can all control. So we can naturally find the corresponding (message, x) to satisfy x = hash (key | mesage).</p>
<h3 id="examples">Examples</h3>
<p>It seems that most of them are inside the web, and I don&#39;t know much about the web. I will not give examples for the time being.</p>
<h3 id="tools">Tools</h3>
<ul>
<li><a href="https://github.com/bwall/HashPump">hashpump</a></li>
</ul>
<p>Please refer to the readme on github for how to use it.</p>
<h2 id="hash-algorithm-is-incorrectly-designed">hash algorithm is incorrectly designed</h2>
<p>Some custom hash algorithms may be reversible.</p>
<h3 id="hashinator">Hashinator</h3>
<p>The logic of the topic is very simple. Pick a <code>password</code> from a well-known password dictionary &quot;rockyou&quot; and use a variety of hash algorithms to randomly hash 32 rounds. We need to crack the original <code>password</code> from the final hash result.</p>
<h4 id="analysis">Analysis</h4>
<p>The hash algorithms used in the title are: <code>md5</code>, <code>sha1</code>, <code>blake</code>, <code>scrypt</code>.
The key code is as follows:</p>
<pre><code class="python">
    password = self.generate_password()     # from rock_you.txt

Salt = self.generate_salt(password) # related to the length of the password
Hash_rounds = self.generate_rounds() # Generate the order in which the hash algorithm is executed
    password_hash = self.calculate_hash(salt + password, hash_rounds)

</code></pre>

<ol>
<li>The program first randomly extracts a <code>password</code> from <code>rockyou.txt</code> as the encrypted plaintext.</li>
<li>Then generate a <code>salt</code> of length <code>128 - len(password)</code> based on the length of the extracted <code>password</code>.</li>
<li>Extract from the four hash algorithms listed above to form 32 rounds of hash operations.</li>
<li>Calculate the last <code>password_hash</code> given to us based on the previously obtained <code>password</code>, <code>salt</code>.</li>
</ol>
<p>Obviously, we can&#39;t complete the problem by the inverse hash algorithm.
We know all the possible plaintexts, first considering whether we can complete the exhaustion by constructing a rainbow table. But notice that in the <code>generate_salt()</code> function, the length combination of <code>salt</code> and <code>password</code> exceeds the length of 128 bytes and is annotated.</p>
<pre><code>
    msize = 128 # f-you hashcat :D

</code></pre>

<p>So, can only helplessly give up.</p>
<p>In that case, there is only one possibility, that is, the algorithm is reversible. Looking at the concrete implementation of the <code>calculate_hash()</code> function, you can find the following suspicious code:</p>
<pre><code class="python">
for i in range(len(hash_rounds)):

    interim_salt = xor(interim_salt, hash_rounds[-1-i](interim_hash))

    interim_hash = xor(interim_hash, hash_rounds[i](interim_salt))

final_hash = interim_salt + interim_hash

</code></pre>

<p>Reorganize the information we know:
1. There are 32 rounds stored in hash_rounds, which is the hash function handle to be used in each round.
2. final_hash is the last hash result for us.
3. The contents of hash_rounds will also be printed to us after generation.
4. We want to get the values of <code>interim_salt</code> and <code>interim_hash</code> in the first round.
5. <code>interim_salt</code> and <code>interim_hash</code> are both 64bytes in length.</p>
<p>A closer look at the calculations of <code>interim_salt</code> and <code>interim_hash</code> reveals that it is reversible.</p>
<p>$$</p>
<p>interim_hash_1 = interim_hash_2 \oplus hash_rounds<a href="interim_salt_3">i</a></p>
<p>$$</p>
<p>In this line of code, we know $interim_hash_1$ and $interim_salt_3$, so we can get the value of $interim_hash_2$, and $interim_hash_2$ is the last round of <code>interim_hash</code>.
By pushing back 32 times in this way, you can get the initial <code>password</code> and <code>salt</code>.</p>
<p>The specific decryption script is:</p>
<pre><code class="python">
import
import hashlib

import socket

import threading

import socketserver

import struct

import time

import threading
# import pyscrypt

from base64 import b64encode, b64decode

from pwn import *

def md5(bytestring):

    return hashlib.md5(bytestring).digest()

def sha(bytestring):

    return hashlib.sha1(bytestring).digest()

def blake(bytestring):

    return hashlib.blake2b(bytestring).digest()

def scrypt(bytestring):

    l = int(len(bytestring) / 2)

    salt = bytestring[:l]

    p = bytestring[l:]

    return hashlib.scrypt(p, salt=salt, n=2**16, r=8, p=1, maxmem=67111936)

    # return pyscrypt.hash(p, salt, 2**16, 8, 1, dkLen=64)

def xor(s1, s2):

    return b''.join([bytes([s1[i] ^ s2[i % len(s2)]]) for i in range(len(s1))])

def main():

# io = socket.socket (family = socket.AF_INET)
# io.connect ((&amp;#39;47.88.216.38&amp;#39;, 20013))
io = remote (&amp;#39;47 .88.216.38 &amp;#39;, 20013)
print (io.recv (1000))
    ans_array = bytearray()

    while True:

buf = io.recv (1)
        if buf:

            ans_array.extend(buf)

        if buf == b'!':

            break



    password_hash_base64 = ans_array[ans_array.find(b&quot;b'&quot;) + 2: ans_array.find(b&quot;'\n&quot;)]

    password_hash = b64decode(password_hash_base64)

    print('password:', password_hash)

    method_bytes = ans_array[

        ans_array.find(b'used:\n') + 6 : ans_array.find(b'\nYour')

    ]

    methods = method_bytes.split(b'\n')

    methods = [bytes(x.strip(b'- ')).decode() for x in methods]

    print(methods)

    in_salt = password_hash[:64]

    in_hash = password_hash[64:]

    for pos, neg in zip(methods, methods[::-1]):

        '''

            interim_salt = xor(interim_salt, hash_rounds[-1-i](interim_hash))

            interim_hash = xor(interim_hash, hash_rounds[i](interim_salt))

        '''

        in_hash = xor(in_hash, eval(&quot;{}(in_salt)&quot;.format(neg)))

        in_salt = xor(in_salt, eval(&quot;{}(in_hash)&quot;.format(pos)))

    print(in_hash, in_salt)

    print(in_hash[-20:])

io.interactive ()
main()



</code></pre>

<h4 id="original-hash-algorithm">Original hash algorithm</h4>
<pre><code class="python">


import
import hashlib

import socket

import threading

import socketserver

import struct

import time



# import pyscrypt



from base64 import b64encode



def md5(bytestring):

    return hashlib.md5(bytestring).digest()



def sha(bytestring):

    return hashlib.sha1(bytestring).digest()



def blake(bytestring):

    return hashlib.blake2b(bytestring).digest()



def scrypt(bytestring):

    l = int(len(bytestring) / 2)

    salt = bytestring[:l]

    p = bytestring[l:]

    return hashlib.scrypt(p, salt=salt, n=2**16, r=8, p=1, maxmem=67111936)

    # return pyscrypt.hash(p, salt, 2**16, 8, 1)



def xor(s1, s2):

    return b''.join([bytes([s1[i] ^ s2[i % len(s2)]]) for i in range(len(s1))])



class HashHandler (socketserver.BaseRequestHandler):


    welcome_message = &quot;&quot;&quot;

Welcome, young wanna-be Cracker, to the Hashinator.



To prove your worthiness, you must display the power of your cracking skills.



The test is easy:

1. We send you a password from the rockyou list, hashed using multiple randomly chosen algorithms.

2. You crack the hash and send back the original password.



As you already know the dictionary and won't need any fancy password rules, {} seconds should be plenty, right?



Please wait while we generate your hash...

    &quot;&quot;&quot;



    hashes = [md5, sha, blake, scrypt]

    timeout = 10

    total_rounds = 32



    def handle(self):

        self.request.sendall(self.welcome_message.format(self.timeout).encode())



        password = self.generate_password()     # from rock_you.txt

Salt = self.generate_salt(password) # related to the length of the password
Hash_rounds = self.generate_rounds() # Generate the order in which the hash algorithm is executed
        password_hash = self.calculate_hash(salt + password, hash_rounds)

        self.generate_delay()



        self.request.sendall(&quot;Challenge password hash: {}\n&quot;.format(b64encode(password_hash)).encode())

        self.request.sendall(&quot;Rounds used:\n&quot;.encode())

        test_rounds = []

        for r in hash_rounds:

            test_rounds.append(r)



        for r in hash_rounds:

            self.request.sendall(&quot;- {}\n&quot;.format(r.__name__).encode())

        self.request.sendall(&quot;Your time starts now!\n&quot;.encode())
        self.request.settimeout(self.timeout)

        try:

            response = self.request.recv(1024)

            if response.strip() == password:

                self.request.sendall(&quot;Congratulations! You are a true cracking master!\n&quot;.encode())

                self.request.sendall(&quot;Welcome to the club: {}\n&quot;.format(flag).encode())

                return

        except socket.timeout:

            pass

        self.request.sendall(&quot;Your cracking skills are bad, and you should feel bad!&quot;.encode())





    def generate_password(self):

        rand = struct.unpack(&quot;I&quot;, os.urandom(4))[0]

        lines = 14344391 # size of rockyou

        line = rand % lines

        password = &quot;&quot;

        f = open('rockyou.txt', 'rb')

        for i in range(line):

            password = f.readline()

        return password.strip()



    def generate_salt(self, p):

        msize = 128 # f-you hashcat :D

        salt_size = msize - len(p)

        return os.urandom(salt_size)



    def generate_rounds(self):

        rand = struct.unpack(&quot;Q&quot;, os.urandom(8))[0]

        rounds = []

        for i in range(self.total_rounds):

            rounds.append(self.hashes[rand % len(self.hashes)])

rand = rand &amp;gt;&amp;gt; 2
        return rounds



    def calculate_hash(self, payload, hash_rounds):

        interim_salt = payload[:64]

        interim_hash = payload[64:]

        for i in range(len(hash_rounds)):

            interim_salt = xor(interim_salt, hash_rounds[-1-i](interim_hash))

            interim_hash = xor(interim_hash, hash_rounds[i](interim_salt))

            '''

            interim_hash = xor(

                interim_hash,

                hash_rounds[i](

                    xor(interim_salt, hash_rounds[-1-i](interim_hash))

                )

            )

            '''

        final_hash = interim_salt + interim_hash

        return final_hash



    def generate_delay(self):

        rand = struct.unpack(&quot;I&quot;, os.urandom(4))[0]

        time.sleep(rand / 1000000000.0)







class ThreadedTCPServer(socketserver.ThreadingMixIn, socketserver.TCPServer):

    allow_reuse_address = True



PORT = 1337

HOST = '0.0.0.0'

flag = &quot;&quot;



with open(&quot;flag.txt&quot;) as f:

    flag = f.read()



def main():

server = ThreadedTCPServer ((HOST, PORT), HashHandler)
    server_thread = threading.Thread(target=server.serve_forever)

    server_thread.start()

    server_thread.join()



if __name__ == &quot;__main__&quot;:

    main()





</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../complex/" class="btn btn-neutral float-right" title="综合">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../fnv/" class="btn btn-neutral" title="FNV"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../fnv/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../complex/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js" defer></script>
      <script src="https://cdnjs.loli.net/ajax/libs/pangu/3.3.0/pangu.min.js" defer></script>
      <script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
      <script src="../../../search/main.js" defer></script>

</body>
</html>
