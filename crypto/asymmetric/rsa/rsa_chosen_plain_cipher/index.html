<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../../../img/favicon.ico">
  <title>选择明密文攻击 - 西山下,闻溪语,书心境</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "\u9009\u62e9\u660e\u5bc6\u6587\u653b\u51fb";
    var mkdocs_page_input_path = "crypto/asymmetric/rsa/rsa_chosen_plain_cipher.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../../.." class="icon icon-home"> 西山下,闻溪语,书心境</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../../../..">Index</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Crypto</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../introduction/">密码学简介</a>
                </li>
                <li class="">
                    
    <span class="caption-text">基础数学知识</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../basic/introduction/">简介</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">古典密码</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../classical/introduction/">古典密码简介</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../classical/monoalphabetic/">单表代换加密</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../classical/polyalphabetic/">多表代换加密</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../classical/others/">其他类型加密</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../classical/summary/">总结</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">流密码</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../streamcipher/intro/">介绍</a>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">伪随机数生成器</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../streamcipher/prng/intro/">介绍</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../streamcipher/prng/csprng/">密码学安全伪随机数生成器</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../streamcipher/prng/problem/">题目</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">线性同余生成器</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../streamcipher/lcg/intro/">简介</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../streamcipher/lcg/challenge/">例题</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">反馈移位寄存器</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../streamcipher/fsr/intro/">介绍</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../streamcipher/fsr/lfsr/">线性反馈移位寄存器</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../streamcipher/fsr/nfsr/">非线性反馈移位寄存器</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">特殊流密码</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../streamcipher/special/rc4/">RC4</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">块加密</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../blockcipher/introduction/">块加密简介</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../blockcipher/arx-operations/">ARX</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../blockcipher/des/">DES</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../blockcipher/idea/">IDEA</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../blockcipher/aes.md">AES</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../blockcipher/simon-speck/">Simon and Speck</a>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">分组模式</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/introduction/">介绍</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/padding/">填充方式</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/ecb/">ECB</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/cbc/">CBC</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/pcbc/">PCBC</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/cfb/">CFB</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/ofb/">OFB</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/ctr/">CTR</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../blockcipher/mode/padding-oracle-attack/">Padding Oracle Attack</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class=" current">
                    
    <span class="caption-text">非对称加密</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../introduction/">非对称加密简介</a>
                </li>
                <li class="toctree-l3 current">
                    
    <span class="caption-text">RSA</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../rsa_theory/">RSA 基本介绍</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../rsa_module_attack/">模数相关攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../rsa_e_attack/">公钥指数相关攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../rsa_d_attack/">私钥 d 相关攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../rsa_coppersmith_attack.md">Coppersmith 相关攻击</a>
                </li>
                <li class="toctree-l4 current">
                    
    <a class="current" href="./">选择明密文攻击</a>
    <ul class="subnav">
            
    <li class="toctree-l5"><a href="#rsa-selecting-a-clear-ciphertext-attack">RSA Selecting a clear ciphertext attack</a></li>
    
        <ul>
        
            <li><a class="toctree-l6" href="#select-plaintext-attack">Select plaintext attack</a></li>
        
            <li><a class="toctree-l6" href="#any-ciphertext-decryption">Any ciphertext decryption</a></li>
        
            <li><a class="toctree-l6" href="#rsa-parity-oracle">RSA parity oracle</a></li>
        
            <li><a class="toctree-l6" href="#rsa-byte-oracle">RSA Byte Oracle</a></li>
        
            <li><a class="toctree-l6" href="#reference">Reference</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../rsa_side_channel/">侧信道攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../rsa_pkcs_attack/">Bleichenbacher 攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../rsa_complex/">综合</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../knapsack/knapsack/">背包加密</a>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">离散对数相关</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../discrete-log/discrete-log/">离散对数</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../discrete-log/elgamal/">Elgamal</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../discrete-log/ecc/">ECC</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">格密码</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../lattice/overview/">格概述</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../lattice/introduction/">格介绍</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../lattice/lattice-reduction/">格基规约算法</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../lattice/cvp/">CVP</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">哈希函数</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../hash/introduction/">哈希函数简介</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../hash/md5/">MD5</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../hash/sha1/">SHA1</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../hash/fnv/">FNV</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../hash/attack/">Hash Attack</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../hash/complex/">综合</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">数字签名</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../signature/introduction/">数字签名简介</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../signature/rsa/">RSA 数字签名</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../signature/elgamal.md">ElGamal 数字签名</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../signature/dsa/">DSA 数字签名</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">攻击思想总结</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../attack-summary/attack-mode/">简介</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../attack-summary/meet-in-the-middle/">中间相遇攻击</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../attack-summary/bit-attack/">比特攻击</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../../about/">About</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../..">西山下,闻溪语,书心境</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../..">Docs</a> &raquo;</li>
    
      
        
          <li>RSA &raquo;</li>
        
      
        
          <li>非对称加密 &raquo;</li>
        
      
        
          <li>Crypto &raquo;</li>
        
      
    
    <li>选择明密文攻击</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p><a href="./">EN</a> | <a href="../rsa_chosen_plain_cipher-zh/">ZH</a></p>
<h1 id="rsa-selecting-a-clear-ciphertext-attack">RSA Selecting a clear ciphertext attack</h1>
<h2 id="select-plaintext-attack">Select plaintext attack</h2>
<p>Here is an example, if we have an encryption oracle, but we don&#39;t know n and e, then</p>
<ol>
<li>We can get n by encrypting oracle.</li>
<li>When e is small ( $e&lt;2^{64}$), we can use the <em>Pollard&#39;s kangaroo algorithm</em> algorithm to get e. This is more obvious.</li>
</ol>
<p>We can encrypt 2, 4, 8, and 16. Then we can know</p>
<p>$ C_2 = 2 ^ {e} \ n $ way</p>
<p>C_4 = $ 4 ^ {e} \ n $ way</p>
<p>$ C_8 = 8 ^ {e} \ n $ way</p>
<p>Then</p>
<p>$c_2^2 \equiv c_4 \bmod n$</p>
<p>$c_2^3 \equiv c_8 \bmod n$</p>
<p>Therefore</p>
<p>$c_2^2-c_4=kn$</p>
<p>$ c_2 ^ 3-c_8 = tn $</p>
<p>We can find the greatest common factor of kn and tn, and the big probability is n. We can also construct more examples to find n more deterministically.</p>
<h2 id="any-ciphertext-decryption">Any ciphertext decryption</h2>
<p>Suppose Alice creates the ciphertext $C = P^e \bmod n$ and sends C to Bob, and assuming we want to decrypt any ciphertext encrypted by Alice, instead of just decrypting C, then we can intercept C, and use the following steps to find P:</p>
<ol>
<li>Select any $X\in Z_n^{*}$, ie X and N.</li>
<li>Calculate $Y=C \times X^e \bmod n$</li>
<li>Since we can choose to ciphertext attack, we find the decryption result corresponding to Y$Z=Y^d$</li>
<li>Then, since $Z=Y^d=(C \times X^e)^d=C^d X=P^{ed} X= PX\bmod n$, since X and N are mutually prime, we are very It is easy to find the corresponding inverse element, and then you can get P</li>
</ol>
<h2 id="rsa-parity-oracle">RSA parity oracle</h2>
<p>Suppose there is currently an Oracle that decrypts a given ciphertext and checks the parity of the decrypted plaintext and returns the corresponding value based on parity, such as 1 for odd numbers and 0 for even numbers. Then given an encrypted ciphertext, we only need log(N) times to know the plaintext message corresponding to this ciphertext.</p>
<h3 id="principle">Principle</h3>
<p>Hypothesis</p>
<p>P $ C = e ^ \ N $ way</p>
<p>The first time we can send to the server</p>
<p>$ C * 2 ^ = e (2P) e ^ \ N $ way</p>
<p>The server will calculate</p>
<p>2P $ \ N $ way</p>
<p>Here</p>
<ul>
<li>2P is an even number and its power is even.</li>
<li>N is an odd number because it is multiplied by two large prime numbers.</li>
</ul>
<p>Then</p>
<ul>
<li>The server returns an odd number, ie $2P \bmod N$ is an odd number, indicating that 2P is greater than N, and an odd number of Ns is subtracted, and because $2P&lt;2N$, an N is subtracted, ie $\frac{N }{2} \leq P &lt; N$, we can also consider rounding down.</li>
<li>If the server returns an even number, then 2P is less than N. That is, $0\leq P &lt; \frac{N}{2}$, we can also round down.</li>
</ul>
<p>Here we use mathematical induction, which assumes that at the ith time, $\frac{xN}{2^{i}} \leq P &lt; \frac{xN+N}{2^{i}}$</p>
<p>Further, at the i+1th time, we can send</p>
<p>$C*2^{(i+1)e}$</p>
<p>The server will calculate</p>
<p>$ 2 ^ {i + 1} P \ way N = 2 ^ {i + 1} P $ kN</p>
<p>$0 \leq 2^{i+1}P-kN&lt;N$ </p>
<p>$ \ frac {kN} {2 ^ {i + 1}} \ leq P &lt;\ frac {kN + N}</p>
<p>According to the result of the ith</p>
<p>$\frac{2xN}{2^{i+1}} \leq P &lt; \frac{2xN+2N}{2^{i+1}}$</p>
<p>Then</p>
<ul>
<li>If the server returns an odd number, then k must be an odd number, k=2y+1, then $\frac{2yN+N}{2^{i+1}} \leq P &lt; \frac{2yN+2N}{2^ {i+1}}$. At the same time, since P necessarily exists, the range obtained by the i+1 and the range obtained by the i-th must have an intersection. So y must be equal to x.</li>
<li>If the server returns an even number, then k must be an even number, k=2y, where y must also be equal to x, then $\frac{2xN}{2^{i+1}} \leq P &lt; \frac{2xN+ N}{2^{i+1}}$</li>
</ul>
<p>Further we can conclude</p>
<pre><code class="c">
lb = 0

ub = N
if server returns 1

lb = (lb + ub) / 2
else:

UB = (Ib + UB) / 2
</code></pre>

<p>Although it is divisible, that is, it is rounded down, but it does not matter that we have analyzed this problem at the beginning.</p>
<h3 id="2018-google-ctf-perfect-secrecy">2018 Google CTF Perfect Secrecy</h3>
<p>Here is an example of the 2018 Google CTF topic.</p>
<pre><code class="python">
#!/usr/bin/env python3

import sys

import random



from cryptography.hazmat.primitives import serialization

from cryptography.hazmat.backends import default_backend





def ReadPrivateKey(filename):

  return serialization.load_pem_private_key(

      open(filename, 'rb').read(), password=None, backend=default_backend())





def RsaDecrypt(private_key, ciphertext):

  assert (len(ciphertext) &lt;=

          (private_key.public_key().key_size // 8)), 'Ciphertext too large'
  return pow(

      int.from_bytes(ciphertext, 'big'),

      private_key.private_numbers().d,

      private_key.public_key().public_numbers().n)





def Challenge(private_key, reader, writer):

  try:

    m0 = reader.read(1)

    m1 = reader.read(1)

    ciphertext = reader.read(private_key.public_key().key_size // 8)

    dice = RsaDecrypt(private_key, ciphertext)

    for rounds in range(100):

      p = [m0, m1][dice &amp; 1]

k = random.randint (0, 2)
c = (word (p) + k)% 2
      writer.write(bytes((c,)))

    writer.flush()

    return 0



  except Exception as e:

    return 1





def main():

  private_key = ReadPrivateKey(sys.argv[1])

  return Challenge(private_key, sys.stdin.buffer, sys.stdout.buffer)





if __name__ == '__main__':

  sys.exit(main())

</code></pre>

<p>As can be seen</p>
<ul>
<li>We can give the server two numbers, and the server will decide which one to use based on the decrypted ciphertext content.</li>
<li>The server will use <code>random.randint(0, 2)</code> to generate a random number and output the associated random 01 byte c.</li>
</ul>
<p>At first glance, it seems to be completely random. Check out <code>random.randint(0, 2)</code> to know that the generated random number is bounded, so the probability of generating an even number is greater than the probability of generating an odd number, then c and p The probability of the same parity is 2/3. Furthermore, by setting m0 and m1, we can know whether the last digit of the decrypted ciphertext is 0 or 1. This is actually the RSA parity oracle.</p>
<p>Exp is as follows</p>
<pre><code class="python">
import gmpy2

from pwn import *

encflag = open('./flag.txt').read()

encflag = encflag.encode('hex')

encflag = int(encflag, 16)

#context.log_level = 'debug'

m = ['\x00', '\x07']

n = 0xDA53A899D5573091AF6CC9C9A9FC315F76402C8970BBB1986BFE8E29CED12D0ADF61B21D6C281CCBF2EFED79AA7DD23A2776B03503B1AF354E35BF58C91DB7D7C62F6B92C918C90B68859C77CAE9FDB314F82490A0D6B50C5DC85F5C92A6FDF19716AC8451EFE8BBDF488AE098A7C76ADD2599F2CA642073AFA20D143AF403D1

e = 65537
flag = &quot;&quot;







def guessvalue(cnt):

    if cnt[0] &gt; cnt[1]:

        return 0

    return 1





i = 0

while True:

    cnt = dict()

cnt [0] = cnt [1] = 0
    p = remote('perfect-secrecy.ctfcompetition.com', 1337)

    p.send(m[0])

    p.send(m[1])

    tmp = pow(2, i)

    two_inv = gmpy2.invert(tmp, n)

    two_cipher = gmpy2.powmod(two_inv, e, n)

    tmp = encflag * two_cipher % n

    tmp = hex(tmp)[2:].strip('L')

    tmp = '0' * (256 - len(tmp)) + tmp

    tmp = tmp.decode('hex')

assert (len (tmp) == 128)
    p.send(tmp)

    #print tmp

    data = &quot;&quot;

    while (len(data) != 100):

        data += p.recv()

    for c in data:

cnt [U8 (c)] + = 1
    p.close()

    flag = str(guessvalue(cnt)) + flag

    print i, flag

    i += 1

</code></pre>

<p>Results are as follows</p>
<pre><code class="shell">
6533021797450432625003726192285181680054061843303961161444459679874621880787893445342698029728203298974356255732086344166897556918532195998159983477294838449903429031335408290610431938507208444225296242342845578895553611385588996615744823221415296689514934439749745119968629875229882861818946483594948270 6533021797450432625003726192285181680054061843303961161444459679874621880787893445342698029728203298974356255732086344166897556918532195998159983477294838449903429031335408290610431938507208444225296242342845578895553611385588996615744823221415296689514934439749745119968629875229882861818946483594948270

</code></pre>

<p>After decoding, you can get flag</p>
<pre><code class="shell">
CTF {h3ll0__17_5_m3_1_w45_w0nd3r1n6_1f_4f73r_4ll_7h353_y34r5_y0u_d_l1k3_70_m337}
</code></pre>

<h3 id="title">Title</h3>
<ul>
<li>
<p>2016 Plaid CTF rabit</p>
</li>
<li>
<p>2016 sharif CTF lsb-oracle-150</p>
</li>
<li>
<p>2018 Backdoor CTF  BIT-LEAKER</p>
</li>
<li>
<p>2018 XMAN trials baby RSA</p>
</li>
</ul>
<h2 id="rsa-byte-oracle">RSA Byte Oracle</h2>
<p>Suppose there is currently an Oracle that decrypts a given ciphertext and gives the last byte of the plaintext. Then given an encrypted ciphertext, we only need $\log_{256}n$ times to know the plaintext message corresponding to this ciphertext.</p>
<h3 id="principle_1">Principle</h3>
<p>This is actually an extension of RSA parity Oracle. Since the last byte can be revealed, then the number of times we get the ciphertext corresponding plaintext should be reduced.</p>
<p>Hypothesis</p>
<p>P $ C = e ^ \ N $ way</p>
<p>The first time we can send to the server</p>
<p>C $ 256 * e ^ = (256P) e ^ \ N $ way</p>
<p>The server will calculate</p>
<p>256P $ \ N $ way</p>
<p>Here</p>
<ul>
<li>256P is an even number.</li>
<li>N is an odd number because it is multiplied by two large prime numbers.</li>
</ul>
<p>Since P is generally less than N, then $256P \bmod N=256P-kn, k&lt;256$. And for two different $k_1, k_2$, we have</p>
<p>$256P-k_1n \not\equiv 256P-k_2n \bmod 256$</p>
<p>We can use the counter-evidence method to prove the above inequality. At the same time, the last byte of $256P-kn$ is actually $-kn$ obtained in the case of modulo 256. So, in fact, we can first enumerate the last byte in the case of 0~255, construct a mapping table of k and the last byte.</p>
<p>When the server returns the last byte b, we can know k according to the mapping table constructed above, that is, subtract k N, that is, $kN \leq 256 P \leq (k+1)N$.</p>
<p>After that, we use mathematical induction to obtain the range of P, that is, assume that at the ith time, $\frac{xN}{256^{i}} \leq P &lt; \frac{xN+N}{256^{i }}$</p>
<p>Further, at the i+1th time, we can send</p>
<p>$C*256^{(i+1)e}$</p>
<p>The server will calculate</p>
<p>$ 256 ^ {i + 1} P \ way N = 256 ^ {i + 1} P $ kN</p>
<p>$0 \leq 256^{i+1}P-kN&lt;N$ </p>
<p>$ \ frac {kN} {256} {i + 1}} \ leq P &lt;\ frac {kN + N}</p>
<p>According to the result of the ith</p>
<p>$\frac{256xN}{256^{i+1}} \leq P &lt; \frac{256xN+256N}{256^{i+1}}$</p>
<p>We can assume $k=256y+t$ here, and the t here is what we can get through the mapping table.</p>
<p>$\frac{256yN+tN}{256^{i+1}} \leq P &lt; \frac{256yN+(t+1)N}{256^{i+1}}$</p>
<p>At the same time, since P necessarily exists, the range obtained by the i+1 and the range obtained by the i-th must have an intersection.</p>
<p>So y must be equal to x.</p>
<p>Further we can summarize this, in the initial case</p>
<pre><code>
lb = 0

ub = N
</code></pre>

<p>Suppose the server returns b, then</p>
<pre><code class="c">
k = mab [b]
interval = (ub-lb)/256

lb = lb + interval * k

ub = lb + interval

</code></pre>

<h3 id="2018-hitcon-lost-key">2018 HITCON lost key</h3>
<p>This is a comprehensive topic. First, we don&#39;t give n. We can use the method of selecting a plaintext attack to get n. Of course, we can further obtain e. Finally, the code is as follows.</p>
<pre><code class="python">
from pwn import *

import gmpy2

from fractions import Fraction

p = process('./rsa.py')

#p = remote('18.179.251.168', 21700)

#context.log_level = 'debug'

p.recvuntil('Here is the flag!\n')

flagcipher = int(p.recvuntil('\n', drop=True), 16)





def long_to_hex(n):

    s = hex(n)[2:].rstrip('L')

    if len(s) % 2: s = '0' + s

    return s





def send(ch, num):

    p.sendlineafter('cmd: ', ch)

    p.sendlineafter('input: ', long_to_hex(num))

    data = p.recvuntil('\n')

    return int(data, 16)





if __name__ == &quot;__main__&quot;:

    # get n

    cipher2 = send('A', 2)

    cipher4 = send('A', 4)

    nset = []

    nset.append(cipher2 * cipher2 - cipher4)



    cipher3 = send('A', 3)

    cipher9 = send('A', 9)

    nset.append(cipher3 * cipher3 - cipher9)

    cipher5 = send('A', 5)

    cipher25 = send('A', 25)

    nset.append(cipher5 * cipher5 - cipher25)

    n = nset[0]

    for item in nset:

        n = gmpy2.gcd(item, n)



    # get map between k and return byte

    submap = {}

    for i in range(0, 256):

        submap[-n * i % 256] = i



    # get cipher256

    cipher256 = send('A', 256)



    back = flagcipher



    L = Fraction(0, 1)

    R = Fraction(1, 1)

    for i in range(128):

        print i

        flagcipher = flagcipher * cipher256 % n

        b = send('B', flagcipher)

        k = submap[b]

        L, R = L + (R - L) * Fraction(k, 256

                                     ), L + (R - L) * Fraction(k + 1, 256)

    low = int(L * n)

    print long_to_hex(low - low % 256 + send('B', back)).decode('hex')

</code></pre>

<h2 id="reference">Reference</h2>
<ul>
<li>
<p>https://crypto.stackexchange.com/questions/11053/rsa-least-significant-bit-oracle-attack</p>
</li>
<li>
<p>https://pastebin.com/KnEUSMxp</p>
</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../rsa_side_channel/" class="btn btn-neutral float-right" title="侧信道攻击">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../rsa_d_attack/" class="btn btn-neutral" title="私钥 d 相关攻击"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../rsa_d_attack/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../rsa_side_channel/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../../..';</script>
    <script src="../../../../js/theme.js" defer></script>
      <script src="https://cdnjs.loli.net/ajax/libs/pangu/3.3.0/pangu.min.js" defer></script>
      <script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
      <script src="../../../../search/main.js" defer></script>

</body>
</html>
